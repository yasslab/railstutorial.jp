<html dir="ltr" dir="ltr">
  <head>
    <title>beginning</title>
    
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr" dir="ltr">
    <div id="book">

<div id="top"></div>


<h1 class="chapter"><a id="sec-7" href="./sign-up#top" class="heading"><span class="number">第7章</span>ユーザー登録</a></h1>


<p>Userモデルができあがったので、いよいよWebサイトになくてはならないユーザー登録機能を追加しましょう。<a class="ref" href="./sign-up#sec-signup_form">7.2</a>ではHTML<em>フォーム</em>を使用して登録情報をWebアプリケーションに送信します。続いて<a class="ref" href="./sign-up#sec-signup_success">7.4</a>ではユーザーを新規作成して情報をデータベースに保存します。ユーザー登録手続きの最後には、作成されたユーザーの新しいプロファイルを表示できるようにするために、ユーザーを<em>表示する</em>ためのページを作成し、ユーザー用のRESTアーキテクチャを実装する第一歩を踏み出します (<a class="ref" href="/chapters/a-demo-app#sec-mvc_in_action">2.2.2</a>)。これまでと同様、開発と同時にテストも作成します。RSpecとCapybaraの適用範囲を拡大し、簡潔かつ表現力豊かな結合テストを作成します。</p>

<p>ユーザープロファイルページを作成するには、その前にデータベースにユーザーが登録されている必要があります。これはいわゆる「卵が先か鶏が先か」問題です。このWebサイトでは、登録ページがない状態でどうやってユーザーを登録しておけばよいでしょうか。幸い、この問題は既に解決されています。<a class="ref" href="/chapters/modeling-users#sec-creating_a_user">6.3.5</a>でRailsコンソールを使用してユーザーレコードを登録してありました。登録していない場合は、上記を参照して登録しておいてください。</p>

<p>バージョン管理を使用している場合は、いつもと同じようにトピックブランチを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b sign-up
</pre></div>
</div>


<div class="label" id="sec-showing_users"></div>


<h2><a id="sec-7_1" href="./sign-up#sec-showing_users" class="heading"><span class="number">7.1</span>ユーザーを表示する</a></h2>


<p>この節では、まずユーザーの名前とプロファイル写真を表示するためのページを作成します。モックアップを<a class="ref" href="./sign-up#fig-profile_mockup_profile_name">図7.1</a>に示しました<sup class="footnote" id="fnref-7_1"><a href="./sign-up#fn-7_1">1</a></sup>。 ユーザープロファイルページの最終的な目標は、<a class="ref" href="./sign-up#fig-profile_mockup">図7.2</a><sup class="footnote" id="fnref-7_2"><a href="./sign-up#fn-7_2">2</a></sup>のようにユーザーのプロファイル写真と基本ユーザーデータ、そしてマイクロポストの一覧を表示することです。(<a class="ref" href="./sign-up#fig-profile_mockup">図7.2</a>では、有名な<em>lorem ipsum</em>ダミーテキストを使用しています。このテキストの成り立ちには<a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">面白いエピソード</a>があるので機会がありましたらどうぞ。) このページを作成したら、<a class="ref" href="/chapters/following-users#top">第11章</a>のサンプル・アプリケーションで使用する予定です。</p>

<div class="label" id="fig-profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_mockup_profile_name_bootstrap.png" alt="profile_mockup_profile_name_bootstrap" /></span></div><div class="caption"><span class="header">図7.1</span><span class="description">この節で作成するユーザープロファイルのモックアップ。<a href="../images/figures/profile_mockup_profile_name_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_mockup_bootstrap.png" alt="profile_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.2</span><span class="description">理想とする最終的なプロファイルページのモックアップ。<a href="../images/figures/profile_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-rails_environments"></div>


<h3><a id="sec-7_1_1" href="./sign-up#sec-rails_environments" class="heading"><span class="number">7.1.1</span>デバッグとRails環境</a></h3>


<p>この節で作成するプロファイルは、このアプリケーションにおける初めての真に動的なページになります。ビューそのものは1ページのコードですが、サイトのデータベースから取り出した情報を使用して各プロファイルの表示をカスタマイズします。サンプルアプリケーションに動的なページを追加する準備として、ここでWebサイトのレイアウトにデバッグ情報を追加しましょう (<a class="ref" href="./sign-up#code-rails_debug">リスト7.1</a>)。これにより、ビルトインの<code>debug</code>メソッドと<code>params</code>変数を使用して、各プロファイルページにデバッグ用の情報が表示されるようになります (詳細については<a class="ref" href="./sign-up#sec-a_users_resource">7.1.2</a>で解説します)。</p>

<div class="label" id="code-rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.1</span> <span class="description">サイトのレイアウトにデバッグ情報を追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>デバッグ出力をきれいに整形するために、<a class="ref" href="/chapters/filling-in-the-layout#top">第5章</a>で作成したカスタムスタイルシートを<a class="ref" href="./sign-up#code-mixin_and_debug">リスト7.2</a>のように追加します。</p>

<div class="label" id="code-mixin_and_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.2</span> <span class="description">デバッグ表示を整形するための追加と、Sassのミックスイン。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>

<span class="cm">/* mixins, variables, etc. */</span>

<span class="nv">$grayMediumLight</span><span class="o">:</span> <span class="mh">#eaeaea</span><span class="p">;</span>

<span class="k">@mixin</span><span class="nf"> box_sizing</span> <span class="p">{</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">miscellaneous</span> <span class="o">*/</span>

<span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">clear</span><span class="o">:</span> <span class="no">both</span><span class="p">;</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>


<p>ここでSassの<em>ミックスイン</em>機能 (ここでは<code>box_sizing</code>) を使用しています。ミックスイン機能を使用することで、CSSルールのグループをパッケージ化して複数の要素に適用することができます。たとえば以下のような変換を行います。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="nc">.</span>
  <span class="o">@</span><span class="nt">include</span> <span class="nt">box_sizing</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>上が以下のように変換されます。</p>

<div class="code"><div class="highlight"><pre><span class="nc">.debug_dump</span> <span class="p">{</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">.</span>
  <span class="na">-moz-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">-webkit-box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
  <span class="na">box-sizing</span><span class="o">:</span> <span class="no">border</span><span class="o">-</span><span class="n">box</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


<p>ミックスインは<a class="ref" href="./sign-up#sec-using_form_for">7.2.2</a>でも使用します。今回の場合、デバッグ出力は<a class="ref" href="./sign-up#fig-home_page_with_debug">図7.3</a>のようになります。</p>

<div class="label" id="fig-home_page_with_debug"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/home_page_with_debug_4_0.png" alt="home_page_with_debug_4_0" /></span></div><div class="caption"><span class="header">図7.3</span><span class="description">サンプルアプリケーションのHomeページ (<a href="http://localhost:3000/">/</a>) にデバッグ情報を表示する。<a href="../images/figures/home_page_with_debug_4_0-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-up#fig-home_page_with_debug">図7.3</a>のデバッグ出力には、描画されるページの状態を把握するのに役立つ情報が含まれます。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">static_pages</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">home</span>
</pre></div>
</div>


<p>これは<code>params</code>の内容で、YAML<sup class="footnote" id="fnref-7_3"><a href="./sign-up#fn-7_3">3</a></sup>というものです。YAMLは基本的にハッシュであり、コントローラとページのアクションを一意に指定します。<a class="ref" href="./sign-up#sec-a_users_resource">7.1.2</a>には別の例もあります。</p>

<p>本番環境にデプロイしたアプリケーションではデバッグ情報を表示したくないので、<a class="ref" href="./sign-up#code-rails_debug">リスト7.1</a>には以下を記述してあります。</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>こうしておくと、デバッグ情報はRailsの3つのデフォルト環境のうち、<em>開発環境</em>でしか表示されなくなります (<a class="ref" href="./sign-up#sidebar-rails_environments">コラム 7.1</a>)<sup class="footnote" id="fnref-7_4"><a href="./sign-up#fn-7_4">4</a></sup>。特に、<code>Rails.env.development?</code>が<code>true</code>になるのは開発環境に限られるため、以下の埋め込みRubyは</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>本番アプリケーションやテストで挿入されることはありません。(テスト環境でデバッグ情報が表示されても直接問題になることはありませんが、よいことではありません。デバッグ情報は開発環境以外では使用すべきではありません。)</p>

<div class="label" id="sidebar-rails_environments"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 7.1</span><span class="description">Railsの3つの環境</span></span>
<p>Railsにはテスト環境 (<tt>test</tt>)、開発環境 (<tt>development</tt>)、そして本番環境 (<tt>production</tt>) の3つの環境がデフォルトで装備されています。Rails consoleのデフォルトの環境は<tt>development</tt>です。</p>

<pre class="verbatim">  $ rails console 
Loading development environment  &gt;&gt; Rails.env
  =&gt; &quot;development&quot;
  &gt;&gt; Rails.env.development?
  =&gt; true
  &gt;&gt; Rails.env.test?
  =&gt; false</pre>


<p>上のように、Railsには<tt>Rails</tt>というオブジェクトがあり、それには環境の論理値 (boolean) を取る<tt>env</tt>という属性があります。たとえば、<tt>Rails.env.test?</tt>はテスト環境では<tt>true</tt>を返し、それ以外の環境では<tt>false</tt>を返します。</p>

<p>テスト環境のデバッグなど、他の環境でconsoleを実行する必要が生じた場合は、環境をパラメータとして<tt>console</tt>スクリプトに渡すことができます。</p>

<pre class="verbatim">  $ rails console test
  Loading test environment
  &gt;&gt; Rails.env
  =&gt; &quot;test&quot;
  &gt;&gt; Rails.env.test?
  =&gt; true</pre>


<p>ローカルのRailsサーバーではconsoleのデフォルトの環境として<tt>development</tt>が使用されますが、以下のように他の環境でconsoleを実行することもできます。</p>

<pre class="verbatim">  $ rails server --environment production</pre>


<p>アプリケーションを本番環境で実行する場合、本番のデータベースが利用できないとアプリケーションを実行できません。そのため、<tt>rake db:migrate</tt>を本番環境で実行して本番データベースを作成します。</p>

<pre class="verbatim">  $ bundle exec rake db:migrate RAILS_ENV=production</pre>


<p>(注: console、server、migrateの3つのコマンドでは、デフォルト以外の環境を指定する方法がそれぞれ異なっており、混乱を招く可能性があります。このため、3つの場合の方法をすべて説明することは避けました。)</p>

<p>ところで、サンプルアプリケーションをHerokuにデプロイした場合は、<tt>heroku</tt>コマンドで環境を確認することができます。これを行うには、Herokuの (リモート) コンソールで以下を実行します。</p>

<pre class="verbatim">  $ heroku run console
  Ruby console for yourapp.herokuapp.com
  &gt;&gt; Rails.env
  =&gt; &quot;production&quot;
  &gt;&gt; Rails.env.production?
  =&gt; true</pre>


<p>当然ながら、Herokuは本番サイト用のプラットフォームなので、実行されるアプリケーションはすべて本番環境となります。</p>
</div>




<div class="label" id="sec-a_users_resource"></div>


<h3><a id="sec-7_1_2" href="./sign-up#sec-a_users_resource" class="heading"><span class="number">7.1.2</span>ユーザーリソース</a></h3>


<p><a class="ref" href="/chapters/modeling-users#top">第6章</a>の最後で、データベースに新しいユーザーを作成しました。<a class="ref" href="/chapters/modeling-users#sec-creating_a_user">6.3.5</a>でこのユーザーのidは<code>1</code>になっており、今の私たちの目標はこのユーザーの情報を表示するページを作成することです。ここでは、Railsアプリケーションで好まれているRESTアーキテクチャ (<a class="ref" href="/chapters/a-demo-app#sidebar-REST">コラム 2.2</a>) の習慣に従うことにしましょう。つまり、データを作成、表示、更新、削除可能な<em>リソース</em>として扱うということです。<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP標準</a>には、これらに対応する4つの基本操作 (<tt>POST</tt>、<tt>GET</tt>、<tt>PATCH</tt>、<tt>DELETE</tt>)が定義されています (<a class="ref" href="/chapters/static-pages#sidebar-get_etc">コラム  3.3</a>)。</p>

<p>RESTの原則に従う場合、リソースへの参照はリソース名とユニークIDを使用するのが普通です。ユーザーを<em>リソース</em>とみなす場合、id=<code>1</code>のユーザーを参照するということは、/users/1というURLに対して<tt>GET</tt>リクエストを発行するということを意味します。ここで<code>show</code>というアクションの種類は、<em>暗黙</em>のリクエストになります。RailsのREST機能が有効になっていると、<tt>GET</tt>リクエストは自動的に<code>show</code>アクションとして扱われます。</p>

<p><a class="ref" href="/chapters/a-demo-app#sec-a_user_tour">2.2.1</a>で説明したとおり、id=<code>1</code>のユーザーにアクセスするためのページのURIは/users/1となります。ただし、現時点でこのURIを使用してもエラーになります (<a class="ref" href="./sign-up#fig-profile_routing_error">図 7.4</a>)。</p>

<div class="label" id="fig-profile_routing_error"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_routing_error.png" alt="profile_routing_error" /></span></div><div class="caption"><span class="header">図7.4</span><span class="description">/users/1にアクセスした時のエラーページ。<a href="../images/figures/profile_routing_error-full.png">(拡大)</a></span></div></div>


<p>RESTスタイルのURLを有効にするには、routesファイル (<code>config/routes.rb</code>)に以下の1行を追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span>
</pre></div>
</div>


<p>変更の結果を<a class="ref" href="./sign-up#code-users_resource">リスト7.3</a>に示します </p>

<div class="label" id="code-users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.3</span> <span class="description">Usersリソースをroutesファイルに追加する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">root</span>  <span class="s1">&#39;static_pages#home&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span><span class="p">,</span>            <span class="ss">via:</span> <span class="s1">&#39;get&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ところで、<a class="ref" href="./sign-up#code-users_resource">リスト7.3</a>には以下の行がありません。</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>この行は<a class="ref" href="/chapters/filling-in-the-layout#code-signup_route">リスト5.33</a>にはありました。実は、<code>resources :users</code>という行は、動作する /users/1 URLを追加するためだけのものではありません。サンプルアプリケーションにこの行を追加すると、ユーザーのURLを生成するための多数の名前付きルート (<a class="ref" href="/chapters/filling-in-the-layout#sec-named_routes">5.3.3</a>) に従って、RESTfulなUsersリソースで必要となる<em>すべての</em>アクションが利用できるようになります<sup class="footnote" id="fnref-7_5"><a href="./sign-up#fn-7_5">5</a></sup>。この行に対応するURL、アクション、名前付きルートは<a class="ref" href="./sign-up#table-RESTful_users">表7.1</a>のようになります (<a class="ref" href="/chapters/a-demo-app#table-demo_RESTful_users">表2.2</a>との違いを比較してみてください)。 次の3つの章に渡って、<a class="ref" href="./sign-up#table-RESTful_users">表7.1</a>の他の項目も利用して、Usersリソースを完全にRESTfulなリソースにするために必要なアクションをすべて作成する予定です。</p>

<div class="label" id="table-RESTful_users"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>名前付きルート</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/users</td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">すべてのユーザーを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">特定のユーザーを表示するページ</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/new</td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">ユーザーを新規作成するページ (ユーザー登録)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/users</td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">ユーザーを作成するアクション</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left">/users/1/edit</td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(user)</code></td><td class="align_left">id=<code>1</code>のユーザーを編集するページ</td></tr><tr><td class="align_left"><tt>PATCH</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">ユーザーを更新するアクション</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/users/1</td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(user)</code></td><td class="align_left">ユーザーを削除するアクション</td></tr></table></div><div class="caption"><span class="header">表7.1</span><span class="description"><a class="ref" href="./sign-up#code-users_resource">リスト7.3</a>のUsersリソースが提供するRESTfulなルート。</span></div></div>


<p><a class="ref" href="./sign-up#code-users_resource">リスト7.3</a>のコードを使用することで、ルーティングが有効になります。ただし、ルーティング先のページはまだありません (<a class="ref" href="./sign-up#fig-user_show_unknown_action_4">図7.5</a>)。この問題を解決するために、<a class="ref" href="./sign-up#sec-a_gravatar_image">7.1.4</a>で最小限のプロファイルページを作成する予定です。</p>

<div class="label" id="fig-user_show_unknown_action_4"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_show_unknown_action_4.png" alt="user_show_unknown_action_4" /></span></div><div class="caption"><span class="header">図7.5</span><span class="description">URI /users/1のルーティングは有効だがページがない状態。<a href="../images/figures/user_show_unknown_action_4-full.png">(拡大)</a></span></div></div>


<p>ユーザーを表示するために、標準的なRailsの場所を使用することにします。<code>app/views/users/show.html.erb</code>です。<a class="ref" href="/chapters/filling-in-the-layout#code-generate_users_controller">リスト5.29</a>でジェネレータを使用して作成した<code>new.html.erb</code>ビューと異なり、この<code>show.html.erb</code>ファイルは自動的には作成されないので、手動で作成します。このファイルを作成後、<a class="ref" href="./sign-up#code-stub_user_view">リスト7.4</a>の内容を貼り付けてください。</p>

<div class="label" id="code-stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.4</span> <span class="description">ユーザー情報を表示するための仮のビュー。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>このビューでは埋め込みRubyを使用してユーザー名とメールアドレスを表示しています。インスタンス変数<code>@user</code>があることを前提としています。もちろん、ユーザー表示ページの最終的な状態はこれとは大きく異なりますし、このメールアドレスがこのまま一般に公開されるようなこともありません。</p>

<p>ユーザー表示ビューが正常に動作するためには、Usersコントローラ内の<code>show</code>アクションに対応する<code>@user</code>変数を定義する必要があります。 ご想像のとおり、ここではUserモデルの<code>find</code>メソッド (<a class="ref" href="/chapters/modeling-users#sec-finding_user_objects">6.1.4</a>) を使用してデータベースからユーザーを取り出します。<a class="ref" href="./sign-up#code-user_show_action">リスト7.5</a>のように書き換えてください。</p>

<div class="label" id="code-user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.5</span> <span class="description">Usersコントローラの<code>show</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザーのid読み出しには<code>params</code>を使用しました。Usersコントローラにリクエストが正常に送信されると、<code>params[:id]</code>の部分はユーザーidの<tt>1</tt>に置き換わります。従って、この箇所は以下の<code>find</code>メソッドと同等です。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>上は<a class="ref" href="/chapters/modeling-users#sec-finding_user_objects">6.1.4</a>で使用したものです (技術的な補足: <code>params[:id]</code>は文字列型の <code>&quot;1&quot;</code> ですが、<code>find</code>メソッドでは自動的に整数型に変換されます)。</p>

<p>ユーザーのビューとアクションが定義されたので、URI <a href="http://localhost:3000/users/1">/users/1</a>は完全に動作するようになりました (<a class="ref" href="./sign-up#fig-user_show_rails_3">図7.6</a>)。<a class="ref" href="./sign-up#fig-user_show_rails_3">図7.6</a>のデバッグ情報で<code>params[:id]</code>の値を確認できることにもご注目ください。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&#39;1&#39;</span>
</pre></div>
</div>


<p>以下のコードを使用して</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>id=<tt>1</tt>のユーザーを検索できたのは以上の仕組みによるものです (<a class="ref" href="./sign-up#code-user_show_action">リスト7.5</a>)。</p>

<div class="label" id="fig-user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_show_bootstrap.png" alt="user_show_bootstrap" /></span></div><div class="caption"><span class="header">図7.6</span><span class="description">Usersリソース追加後の<a href="http://localhost:3000/users/1">/users/1</a>のユーザー表示ページ。 <a href="../images/figures/user_show_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-tests_with_factories"></div>


<h3><a id="sec-7_1_3" href="./sign-up#sec-tests_with_factories" class="heading"><span class="number">7.1.3</span>ファクトリーを使用してユーザー表示ページをテストする</a></h3>


<p>最小限のプロファイルが動作するようになりましたので、<a class="ref" href="./sign-up#fig-profile_mockup_profile_name">図7.1</a>のモックアップバージョンの作成を始めましょう。静的なページの作成 (<a class="ref" href="/chapters/static-pages#top">第3章</a>) やUserモデル (<a class="ref" href="/chapters/modeling-users#top">第6章</a>) のときと同様に、テスト駆動開発を行います。</p>

<p><a class="ref" href="/chapters/filling-in-the-layout#sec-signup_url">5.4.2</a>では、Usersリソースに関連付けられたページに対して行った結合テストを思い出してください。ユーザー登録ページでは、<a class="ref" href="/chapters/filling-in-the-layout#code-user_pages_spec">リスト5.32</a>のように最初に<code>signup_path</code>をテストし、次に<code>h1</code>タグと<code>title</code>タグが正しいことをチェックしました。これを再現したものが<a class="ref" href="./sign-up#code-initial_signup_test">リスト7.6</a>です (<a class="ref" href="/chapters/filling-in-the-layout#sec-pretty_rspec">5.3.4</a>の<code>full_title</code>ヘルパーについては、フルタイトルが既にテスト済みであることから省略しました)。</p>

<div class="label" id="code-initial_signup_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.6</span> <span class="description">最初に行ったUserページspecの再現。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ユーザー表示ページをテストするために、<code>show</code>アクションのコード (<a class="ref" href="./sign-up#code-user_show_action">リスト7.5</a>) で検索を行うUserモデルオブジェクトが必要となります。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
  <span class="c1"># ユーザー変数を作成するためのコードに置き換える。</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これからコメントの部分に適切なコードを追加します。ここでは<code>user_path</code>という名前付きルート (<a class="ref" href="./sign-up#table-RESTful_users">表7.1</a>) を使用して、指定されたユーザーのページを表示するためのパスを生成します。これにより、ページのコンテンツとタイトルの両方にユーザーの名前が含まれているかどうかをテストできます。</p>

<p>必要なUserモデルオブジェクトを作成するために、Active Recordを使用して<code>User.create</code>という形式でユーザーを作成することもできますが、経験上、ユーザーのオブジェクトを定義してそれをデータベースに挿入するには、ユーザーの<em>ファクトリー (factory)</em> を使用する方がはるかに便利です。ここでは、<a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a>を使用して生成したファクトリーを使用します。Factory Girlは、<a href="http://thoughtbot.com/">thoughtbot</a>のメンバーが作成したRuby gemです。Factory Girlは、RSpecを使用してRubyで「ドメイン特化言語 (domain-specific language)」を定義します。ここでは、Active Recordのオブジェクトの定義に特化しています。このドメイン特化言語の文法はシンプルで、必要なオブジェクトの属性を定義するためにRubyのブロックとカスタムメソッドを使用しています。この章のサンプルアプリケーションでは、Active Recordのメリットはまだはっきりとはわからないかもしれませんが、この後の章ではファクトリーの機能をさらに活用する予定です。たとえば<a class="ref" href="/chapters/updating-showing-and-deleting-users#sec-pagination">9.3.3</a>では、複数のユーザーを作成し、それぞれに独自のメールアドレスを持たせる作業が重要となりますが、ファクトリーを使用することで簡単になります。</p>

<p>他のRuby gemと同様、Bundlerで使用する<code>Gemfile</code>に以下のように1行追加することでFactory Girlをインストールできます (<a class="ref" href="./sign-up#code-gemfile_factory_girl">リスト7.7</a>) (Factory Girlはテスト環境でしか使用しないので、以下のように<code>:test</code>グループに追加します)。</p>

<div class="label" id="code-gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.7</span> <span class="description"><code>Gemfile</code>にFactory Girlを追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.2.1&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に、いつものように以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Factory Girlのファクトリーはすべて<code>spec/factories.rb</code>ファイルに置きます。ここにあるファクトリーはRSpecによって自動的に読み込まれます。Userファクトリが見えるようにするためのコードは<a class="ref" href="./sign-up#code-user_factory">リスト7.8</a>です。</p>

<div class="label" id="code-user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.8</span> <span class="description">Userモデルオブジェクトをシミュレートするためのファクトリー。</span><br /><span class="description"> <code>spec/factories.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:user</span> <span class="k">do</span>
    <span class="nb">name</span>     <span class="s2">&quot;Michael Hartl&quot;</span>
    <span class="n">email</span>    <span class="s2">&quot;michael@example.com&quot;</span>
    <span class="n">password</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>シンボル<code>:user</code>が<code>factory</code>コマンドに渡されると、Factory Girlはそれに続く定義がUserモデルオブジェクトを対象としていることを認識します。</p>

<p><a class="ref" href="./sign-up#code-user_factory">リスト7.8</a>の定義を使用することで、Factory Girlの<code>let</code>コマンドと<code>FactoryGirl</code>メソッド (<a class="ref" href="/chapters/modeling-users#sidebar-let">コラム 6.3</a>) を使用してUserのファクトリーを作成することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>最終的なコードは<a class="ref" href="./sign-up#code-user_show_page_test">リスト7.9</a>のようになります。</p>

<div class="label" id="code-user_show_page_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.9</span> <span class="description">ユーザー表示ページ用のテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;profile page&quot;</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;signup page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">full_title</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この時点で以下を実行すると、テストスイートが赤色 (失敗) になるはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>このコードは、<a class="ref" href="./sign-up#code-name_title_and_heading">リスト7.10</a>のようにすることで緑色 (成功) になります。</p>

<div class="label" id="code-name_title_and_heading"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.10</span> <span class="description">ユーザーのプロファイルページにタイトルと見出しを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>以下のコマンドを再度実行すると、<a class="ref" href="./sign-up#code-user_show_page_test">リスト7.9</a>はパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>Factory Girlを使用したテストを実行してみるとすぐに気が付くと思いますが、正直言って<em>遅い</em>です。 これはFactory Girlに問題があるわけではなく、あくまで<em>機能</em>の一部であり、バグではありません。<a class="ref" href="/chapters/modeling-users#sec-an_encrypted_password">6.3.1</a>で使用したBCryptアルゴリズムによるセキュアパスワードのハッシュ生成そのものが仕様上遅いのが原因です。BCryptが遅いということは、裏を返せばそれだけ攻撃に強いということでもあります。残念ながら、このままではユーザーの作成をそのままテストに含めると遅くなってしまいます。幸いなことに、この問題は簡単に回避できます。<tt>BCrypt-ruby</tt>ライブラリでは、セキュアハッシュを生成する際の計算の負荷を<em>コストファクター (cost factor) </em>として指定できます。コストファクターのデフォルト値は速度よりセキュアであることを重視しています。これは本番環境では最適ですが、テスト環境では不利です。私たちはテストを<em>高速で</em>行いたいのであり、ユーザーのパスワードハッシュのセキュリティについてはテスト中は気にしたくありません。解決方法は、<a class="ref" href="./sign-up#code-test_bcrypt_cost_factor">リスト7.11</a>に示すように、テスト設定ファイル<code>config/environments/test.rb</code>に数行追加することです。これによりコストファクターが再定義され、デフォルトのセキュリティ重視から速度重視の最小値に変わります。 かなり小規模なテストであっても、この修正によって速度は相当向上します。<code>test.rb</code>にはいつも<a class="ref" href="./sign-up#code-test_bcrypt_cost_factor">リスト7.11</a>の数行を追加しておくことをぜひともお勧めします。</p>

<div class="label" id="code-test_bcrypt_cost_factor"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.11</span> <span class="description">BCryptのコストファクターをテスト環境向けに再定義する。</span><br /><span class="description"> <code>config/environments/test.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># bcrypt&#39;のコスト関数を下げることでテストの速度を向上させる。</span>
  <span class="ss">ActiveModel::SecurePassword</span><span class="o">.</span><span class="n">min_cost</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-a_gravatar_image"></div>


<h3><a id="sec-7_1_4" href="./sign-up#sec-a_gravatar_image" class="heading"><span class="number">7.1.4</span>gravatar画像とサイドバー</a></h3>


<p>前節で基本的なユーザーページの定義は終わりましたので、今度は各ユーザーのプロファイル写真のあたりをもう少し肉付けし、サイドバーも作り始めましょう。ビューを作成するときは、ページの構造が正確であるかどうかよりもページの外観の方を重要視するのが普通なので、少なくとも今はビューをテストする必要はありません。ページネーション (<a class="ref" href="/chapters/updating-showing-and-deleting-users#sec-pagination">9.3.3</a>) のような、エラーの起きやすい要素をビューで使用するようになったら、ビューでもテスト駆動開発を行います。</p>

<p>ここでは<a href="http://gravatar.com/">Gravatar (globally recognized avatar) </a>をユーザープロファイルに導入してみましょう<sup class="footnote" id="fnref-7_6"><a href="./sign-up#fn-7_6">6</a></sup>。Gravatarは<a href="http://github.com/">GitHub</a>の共同設立者であるTom Preston-Wernerによって開発され、後に<a href="http://automattic.com/">Automattic</a> (<a href="http://wordpress.com/">WordPress</a>の作者) に買い取られました。Gravatarは無料のサービスで、プロファイル写真をアップロードして、指定したメールアドレスと関連付けることができます。Gravatarは、プロファイル写真をアップロードするときの面倒な作業や、写真が欠けたりなどのトラブル、置き場所の悩みを解決します。ユーザーのメールアドレスを組み込んだGravatar専用の画像パスを構成するだけで、対応するGravatarの画像が自動的に表示されます<sup class="footnote" id="fnref-7_7"><a href="./sign-up#fn-7_7">7</a></sup>。</p>

<p>ここでは、<a class="ref" href="./sign-up#code-user_show_view_with_gravatar">リスト7.12</a>のように<code>gravatar_for</code>ヘルパー関数を使用してGravatarの画像を利用できるようにします。</p>

<div class="label" id="code-user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.12</span> <span class="description">ユーザー表示ビューに名前とGravatarを表示する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>この時点では、以下のテストスイートは失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p><code>gravatar_for</code>メソッドが未定義のため、ユーザー表示ビューは現在動作していません。(このようなエラーを捉えることができるのが、ビューでSpecsを使用する大きなメリットです。だからこそ、どんなに小規模であってもよいのでビューで<em>何らかの</em>テストを行っておくことが重要なのです。)</p>

<p>デフォルトでは、ヘルパーファイルで定義されているメソッドは自動的にすべてのビューで利用できます。ここでは、利便性を考えて<code>gravatar_for</code>をUsersコントローラに関連付けられているヘルパーファイルに置くことにしましょう。<a href="http://en.gravatar.com/site/implement/hash/">Gravatarのホームページ</a>にも書かれているように、GravatarのURLは<a href="http://en.wikipedia.org/wiki/MD5">MD5ハッシュ</a>を用いてユーザーのメールアドレスをハッシュ化しています。Rubyでは、<code>Digest</code>ライブラリの<code>hexdigest</code>メソッドを使用したMD5ハッシュアルゴリズムが実装されています。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;MHARTL@example.</span><span class="s2">COM&quot;</span><span class="o">.</span>
<span class="gp">&gt;&gt; </span><span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
<span class="go">=&gt; &quot;1fda4469bcbec3badf5418269ffc5968&quot; </span>
</pre></div>
</div>


<p>メールアドレスは大文字小文字を区別しますが (<a class="ref" href="/chapters/modeling-users#sec-format_validation">6.2.4</a>)、MD5ハッシュでは大文字小文字は区別されないので、Rubyの<code>downcase</code>メソッドを使用して<code>hexdigest</code>の引数を小文字に変換しています。<code>gravatar_for</code>ヘルパーを組み込んだ結果を<a class="ref" href="./sign-up#code-gravatar_for_helper">リスト7.13</a>に示しました。</p>

<div class="label" id="code-gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.13</span> <span class="description"><code>gravatar_for</code>ヘルパーメソッドを定義する。</span><br /><span class="description"> <code>app/helpers/users_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># 与えられたユーザーのGravatar (http://gravatar.com/) を返す。</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-up#code-gravatar_for_helper">リスト7.13</a>のコードは、Gravatarの画像タグに<code>&quot;gravatar&quot;</code>クラスとユーザー名のaltテキストを追加したものを返します (altテキストを追加しておくと、視覚障害のあるユーザーがスクリーンリーダーを使用するときにも役に立ちます)。今度は以下のテストスイートは成功するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>プロファイルページは<a class="ref" href="./sign-up#fig-profile_with_gravatar">図7.7</a>のようになります。ここにはデフォルトのGravatar画像が表示されていますが、これはデフォルトのメールアドレス<code>user@example.com</code>が有効ではないためです (<a href="http://example.com/">example.com</a>というドメイン名は、例として使用するために特別に予約されています)。</p>

<div class="label" id="fig-profile_with_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_with_gravatar_bootstrap_4_0.png" alt="profile_with_gravatar_bootstrap_4_0" /></span></div><div class="caption"><span class="header">図7.7</span><span class="description">ユーザープロファイルページ<a href="http://localhost:3000/users/1">/users/1</a>にデフォルトのGravatarが表示されている。<a href="../images/figures/profile_with_gravatar_bootstrap_4_0-full.png">(拡大)</a></span></div></div>


<p>アプリケーションでカスタムGravatarを利用できるようにするために、<code>update_attributes</code> (<a class="ref" href="/chapters/modeling-users#sec-updating_user_objects">6.1.5</a>) を使用してデータベース上のユーザー情報を更新します。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                       <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>ここではユーザーのメールアドレスに <code>example@railstutorial.org</code> を使用しました (<a class="ref" href="./sign-up#fig-profile_custom_gravatar">図7.8</a>)。このメールアドレスはRailsチュートリアルのロゴでも使用されています。</p>

<div class="label" id="fig-profile_custom_gravatar"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_custom_gravatar_bootstrap_4_0.png" alt="profile_custom_gravatar_bootstrap_4_0" /></span></div><div class="caption"><span class="header">図7.8</span><span class="description">ユーザー表示ページにカスタムのGravatarを表示する。<a href="../images/figures/profile_custom_gravatar_bootstrap_4_0-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-up#fig-profile_mockup_profile_name">図7.1</a>のモックアップに近づけるために、ユーザーのサイドバーの最初のバージョンを作りましょう。ここでは<code>aside</code>タグを使用して実装します。このタグはサイドバーなどの補完コンテンツの表示に使用されますが、単独で表示することもできます。<code>row</code>クラスと<code>span4</code>クラスも追加しておきます。これらのクラスはBootstrapの一部です。ユーザー表示ページを変更した結果を<a class="ref" href="./sign-up#code-user_show_with_sidebar">リスト7.14</a>に示します。</p>

<div class="label" id="code-user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.14</span> <span class="description">ユーザーの<code>show</code>ビューにサイドバーを追加する。</span><br /><span class="description"> <code>app/views/users/show.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;aside</span> <span class="na">class=</span><span class="s">&quot;span4&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/aside&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>HTML要素とCSSクラスを配置したことにより、プロファイルページ (とサイドバーとGravatar) にSCSSで<a class="ref" href="./sign-up#code-sidebar_css">リスト7.15</a>のようにスタイルを与えることができるようになりました (テーブルCSSのルールがネスティング (入れ子) されていますが、これが有効になるのはAsset PipelineでSassエンジンが使用されている場合に限られます) 。ページの変更の結果を<a class="ref" href="./sign-up#fig-user_show_sidebar_css">図7.9</a>に示します。</p>

<div class="label" id="code-sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.15</span> <span class="description">SCSSを使用してサイドバーなどのユーザー表示ページにスタイルを与える。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">sidebar</span> <span class="o">*/</span>

<span class="nt">aside</span> <span class="p">{</span>
  <span class="nt">section</span> <span class="p">{</span>
    <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
    <span class="na">border-top</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="nv">$grayLighter</span><span class="p">;</span>
    <span class="k">&amp;</span><span class="nd">:first-child</span> <span class="p">{</span>
      <span class="na">border</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="na">padding-top</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">span</span> <span class="p">{</span>
      <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">line-height</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nt">h1</span> <span class="p">{</span>
      <span class="na">font-size</span><span class="o">:</span> <span class="mi">1</span><span class="mf">.4</span><span class="kt">em</span><span class="p">;</span>
      <span class="na">text-align</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
      <span class="na">letter-spacing</span><span class="o">:</span> <span class="mi">-1</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
      <span class="na">margin-top</span><span class="o">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="na">float</span><span class="o">:</span> <span class="no">left</span><span class="p">;</span>
  <span class="na">margin-right</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_show_sidebar_css_bootstrap.png" alt="user_show_sidebar_css_bootstrap" /></span></div><div class="caption"><span class="header">図7.9</span><span class="description">ユーザー表示ページ<a href="http://localhost:3000/users/1">/users/1</a>にサイドバーとCSSを追加する。<a href="../images/figures/user_show_sidebar_css_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-signup_form"></div>


<h2><a id="sec-7_2" href="./sign-up#sec-signup_form" class="heading"><span class="number">7.2</span>ユーザー登録フォーム</a></h2>


<p>ここまででユーザープロファイルページがひとまず動作するようになりましたので、今度はユーザー登録フォームを作成しましょう。<a class="ref" href="/chapters/filling-in-the-layout#fig-new_signup_page">図5.9</a> (<a class="ref" href="./sign-up#fig-blank_signup_page_recap">図7.10</a>にも再録) に示したとおり、ユーザー登録ページはまだ空白のままなので、このままではユーザー登録できません。この節の目標は、このみっともないページを改造して<a class="ref" href="./sign-up#fig-signup_mockup">図7.11</a>のモックアップのようなページに変えることです。</p>

<div class="label" id="fig-blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/new_signup_page_bootstrap.png" alt="new_signup_page_bootstrap" /></span></div><div class="caption"><span class="header">図7.10</span><span class="description">現状のユーザー登録ページ  <a href="http://localhost:3000/signup">/signup</a>。<a href="../images/figures/new_signup_page_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_mockup_bootstrap.png" alt="signup_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.11</span><span class="description">ユーザー登録ページのモックアップ。<a href="../images/figures/signup_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>Web経由でユーザーを作成する機能をこれから追加しますので、<a class="ref" href="/chapters/modeling-users#sec-creating_a_user">6.3.5</a>で作成したユーザーをここで削除しておきましょう。 最も簡単な方法は、Rakeの<code>db:reset</code>タスクを実行してデータベースをリセットすることです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:reset
</pre></div>
</div>


<p>システム環境によっては、データベースをリセットした後にもう一度prepareを実行しておく必要が生じることがあります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>


<p>最後に、システムによっては変更を反映するためにターミナルで<tt>Ctrl-C</tt>を押してWebサーバーを再起動する必要が生じることもあります<sup class="footnote" id="fnref-7_8"><a href="./sign-up#fn-7_8">8</a></sup>。</p>

<div class="label" id="sec-tests_for_user_signup"></div>


<h3><a id="sec-7_2_1" href="./sign-up#sec-tests_for_user_signup" class="heading"><span class="number">7.2.1</span>ユーザー登録のためのテスト</a></h3>


<p>完全なテスト機能を備えた強力なWebフレームワークがなかった頃は、テスティング作業は苦痛に満ち、しばしばそこでエラーが発生しました。たとえば、もし仮にユーザー登録ページを手動でテストしなければならないとしたら、ブラウザでそのページを表示し、有効なデータと無効なデータを交互に流しこみ、どちらの場合にもアプリケーションが正常に動作することを確認しなければならないでしょう。さらに、アプリケーションに変更が生じるたびに、まったく同じテストを繰り返さなければなりません。RSpecとCapybaraを使用することで、柔軟性の高いテストを作成できるようになり、従来手動で行うしかなかったこれらのテストを自動化できるようになりました。</p>

<p>私たちは、既にCapybaraがWeb操作の文法を直感的にサポートしているところを目の当たりにしてきました。これまでは、特定のページを参照するときに<code>visit</code>を使用することがほとんどでしたが、Capybaraの能力はそれだけにとどまりません。<a class="ref" href="./sign-up#fig-signup_mockup">図7.11</a>のフィールドに文字列を入力したり、ボタンをクリックしたりすることもできます。Capybaraの文法は以下のような感じです。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>目標は、正しくないユーザー登録情報と正しいユーザー登録情報を与えたときに、期待どおりに動作することを確認するテストの作成です。このテストはかなり込み入っているので、1つ1つ作り上げていきましょう。テストの動作結果や、どこにテストを置けばよいかなどをとにかく参照したい場合は、<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>までスキップしてください。</p>

<p>最初のタスクは、ユーザー登録フォームの表示が失敗しないかどうか、そしてページを表示し、ボタンを押し、無効なデータを送信する動作をシミュレートすることです。ボタンを代わりに押すには<code>click_button</code>を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>このテストは、ユーザー登録ページをブラウザで表示し、ユーザー登録情報に何も入力しないまま送信する操作 (無効な操作) と同等です。同様に、有効なデータを送信する操作をシミュレートするには、 <code>fill_in</code>を使用して正しいユーザー情報を与えます。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>このテストの目的は、ユーザー登録ボタンを押したときに期待どおりに動作すること、ユーザー情報が有効な場合にはユーザーが新規作成され、無効な場合にはユーザーが作成されないことを確認することです。これを確認するには、ユーザーの<em>count</em>を使用します。背後で動作するこの<code>count</code>メソッドは、<code>User</code>を含むあらゆるActive Recordクラスで使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>この節の冒頭でデータベースをリセットしてあるので、現時点では<code>User.count</code>は<code>0</code>になっています。</p>

<p>無効なデータを送信した場合、ユーザーのカウントが変わらないことが期待されます。有効なデータを送信した場合には、ユーザーのカウントが1つ増えることが期待されます。このような動作は、RSpecで<code>expect</code>メソッドを<code>to</code>メソッドまたは <code>not_to</code>メソッドと組み合わせて実現できます。まずは、確認しやすい無効な場合についてやってみましょう。ユーザー登録ページのパスをブラウザで開いてボタンをクリックしたら、ユーザーアカウントが変更<em>されない</em>という動作です。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>ここで、<code>expect</code>が<code>click_button</code>を中かっこで囲んでブロックになっていることに注目してください (<a class="ref" href="/chapters/rails-flavored-ruby#sec-blocks">4.3.2</a>)。これは<code>change</code>メソッドで役に立ちます。このメソッドはオブジェクトとシンボルを引数に取り、シンボルを呼び出した結果を計算してオブジェクト上のメソッドとします。これはブロックの前と後いずれについても行われます。つまり、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>以下を計算します。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>上の計算は、以下の実行前と実行後の両方で行われます。</p>

<div class="code"><div class="highlight"><pre><span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
</pre></div>
</div>


<p>この場合は、コードがカウントを変更<em>しない</em>ことが期待されますので、<code>not_to</code>メソッドで表現しています。実際には、以下の同等のコードを</p>

<div class="code"><div class="highlight"><pre><span class="n">initial</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="n">final</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="n">expect</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="n">final</span>
</pre></div>
</div>


<p>ボタンクリックをブロックで囲むことによって以下のように1行で表しています。</p>

<div class="code"><div class="highlight"><pre><span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>こうすることで英語に近い自然な表記が可能になり、さらにコンパクトになります (<code>eq</code>は同値性をテストするRSpecのメソッドです)。</p>

<p>データが有効な場合のテストも大きな違いはありませんが、今度はカウントが更新されないのではなく、カウントが1つ増えることを確認します。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signup_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">expect</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Create my account&quot;</span>
<span class="k">end</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>ここでは<code>to</code>メソッドを使用して、正しいデータを与えてユーザー登録ボタンを押したときにカウントが1つ<em>増える</em>ことを確認します。</p>

<p>上の2つのテストを適切な<code>describe</code>ブロックで囲い、両者に共通する部分を<code>before</code>ブロックに移動すると、<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>のようにユーザー登録を正しくテストできる基本的なテストのできあがりです。ここでは、送信ボタン用の共通部分を分解するために<code>let</code>メソッドを使用して<code>submit</code>変数を定義しています。</p>

<div class="label" id="code-basic_signup_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.16</span> <span class="description">ユーザー登録の基本的なテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:submit</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;Create my account&quot;</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;should not create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">not_to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span>         <span class="ss">with:</span> <span class="s2">&quot;Example User&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">with:</span> <span class="s2">&quot;user@example.com&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="s2">&quot;foobar&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a user&quot;</span> <span class="k">do</span>
        <span class="n">expect</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>この節では、他にもいくつかのテストを追加する予定ですが、<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>の基本テストだけでも既に相当量の機能をカバーしています。テストにパスするには、ユーザー登録ページを正しいHTML要素で作成し、ページの送信が正しい場所へルーティングされるようにし、ユーザーデータが正しい場合にのみ新しいユーザーを作成できるようにする必要があります。</p>

<p>もちろん、今の時点ではテストは失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-using_form_for"></div>


<h3><a id="sec-7_2_2" href="./sign-up#sec-using_form_for" class="heading"><span class="number">7.2.2</span><tt>form_for</tt>を使用する</a></h3>


<p>テストが正しく失敗したので、今度はユーザー登録の<em>フォーム</em>を作成してテストにパスするようにしましょう。これを行うには、Railsで<code>form_for</code>ヘルパーメソッドを使用します。このメソッドはActive Recordオブジェクトを取り込み、オブジェクトの属性を使用してフォームを構成します。変更の結果を<a class="ref" href="./sign-up#code-signup_form">リスト7.17</a>に示します (Rails 2.xに慣れている方は、<code>form_for</code>ではコンテンツを挿入するときに “%=” を使用するERb方式の文法を使用していることに注意してください。Rails 2.xでは<tt class="verb">&lt;% form_for ... %&gt;</tt>を使用していましたが、現在は代わりに<tt class="verb">&lt;%= form_for ... %&gt;</tt>を使用します)。</p>

<div class="label" id="code-signup_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.17</span> <span class="description">新しいユーザーを登録するフォーム。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Create my account&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>このフォームの各部分について見てみましょう。<code>do</code>キーワードは、 <code>form_for</code>が1つの変数を持つブロックを取ることを表します。この変数<code>f</code>は “form” のfです。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>通常、Railsヘルパーを使用している場合、実装の詳細について知っておく必要はありません。ただし<code>f</code>というオブジェクトが<em>何をするのか</em>は知っておく必要があります。 <a href="http://www.w3schools.com/html/html_forms.asp">HTMLフォーム要素</a> (テキストフィールド、ラジオボタン、パスワードフィールドなど) に対応するメソッドが呼び出されると、<code>@user</code> オブジェクトの属性を設定するように特別に設計された要素のためのコードを返します。つまり、以下のコードを実行すると、</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Userモデルの<code>name</code>属性を設定する、ラベル付きテキストフィールド要素を作成するのに必要なHTMLを作成します (HTML自体については<a class="ref" href="./sign-up#sec-the_form_html">7.2.3</a>で詳しく説明します)。</p>

<p>実際の動作を理解するには、このフォームによって生成される実際のHTMLについて理解を深める必要があります。しかしここで問題があります。このページでは<code>@user</code>変数に何も設定されておらず、未完成です。 他のすべての未定義インスタンス変数 (<a class="ref" href="/chapters/rails-flavored-ruby#sec-a_user_class">4.4.5</a>) と同様、<code>@user</code>の内容は現時点では<code>nil</code>です。従って、この時点でテストスイートを実行すると、<a class="ref" href="./sign-up#code-initial_signup_test">リスト7.6</a>のユーザー登録ページのコンテンツに対するテストは失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>(この<code>-e</code>オプションは、descriptionの文字列が<code>&quot;signup page&quot;</code>に一致する例を単に実行するためのものです。ここで注意していただきたいのは、これは <code>&quot;signup&quot;</code> という部分文字列とは<em>違う</em>ということです。もし&quot;signup&quot; であれば<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>のすべてのテストが実行されるでしょう。) テストにパスしてフォームが正常に出力されるようにするには、<code>new.html.erb</code>に対応する<code>@user</code>変数をコントローラのアクションで定義する必要があります。たとえば、Usersコントローラの<code>new</code>がそうです。<code>form_for</code>ヘルパーは<code>@user</code>がUserオブジェクトであることを前提としています。ここでは<em>新しい</em>ユーザーを作成するので、<a class="ref" href="./sign-up#code-new_action_with_user">リスト7.18</a>のように単に<code>User.new</code>とします。</p>

<div class="label" id="code-new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.18</span> <span class="description"><code>@user</code>変数を<code>new</code>アクションに追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>@user</code>変数が上記のように定義されれば、以下のユーザー登録ページのテストはパスするはずです (訳注: 以下のコマンドでは &quot;signup page&quot; のテストだけを行なっています)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb -e <span class="s2">&quot;signup page&quot;</span>
</pre></div>
</div>


<p>この時点で、フォーム に<a class="ref" href="./sign-up#code-form_css">リスト7.19</a>のようにスタイルが与えられていれば、<a class="ref" href="./sign-up#fig-signup_form">図7.12</a>のように表示されます。<code>box_sizing</code>ミックスインを<a class="ref" href="./sign-up#code-mixin_and_debug">リスト7.2</a>から再利用していることにご注目ください。</p>

<div class="label" id="code-form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.19</span> <span class="description">ユーザー登録フォームのCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>

<span class="nt">input</span><span class="o">,</span> <span class="nt">textarea</span><span class="o">,</span> <span class="nt">select</span><span class="o">,</span> <span class="nc">.uneditable-input</span> <span class="p">{</span>
  <span class="na">border</span><span class="o">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="no">solid</span> <span class="mh">#bbb</span><span class="p">;</span>
  <span class="na">width</span><span class="o">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
  <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">@include</span><span class="nd"> box_sizing</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span> <span class="p">{</span>
  <span class="na">height</span><span class="o">:</span> <span class="no">auto</span> <span class="nv">!</span><span class="nv">important</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_form_bootstrap.png" alt="signup_form_bootstrap" /></span></div><div class="caption"><span class="header">図7.12</span><span class="description">新規ユーザーのためのユーザー登録フォーム<a href="http://localhost:3000/signup">/signup</a>。<a href="../images/figures/signup_form_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_form_html"></div>


<h3><a id="sec-7_2_3" href="./sign-up#sec-the_form_html" class="heading"><span class="number">7.2.3</span>フォームHTML</a></h3>


<p><a class="ref" href="./sign-up#fig-signup_form">図7.12</a>に示したように、ユーザー登録は正常に表示されるようになりました。これは、<a class="ref" href="./sign-up#code-signup_form">リスト7.17</a>の<code>form_for</code>コードが正しいHTMLを生成しているということです。生成されたフォームのHTMLソースを見てみると (<a href="http://getfirebug.com/">Firebug</a>を使うか、ブラウザの [ソースを表示] を使用)、ソースのマークアップは<a class="ref" href="./sign-up#code-signup_form_html">リスト7.20</a>のようになっているはずです。このHTMLの細かい部分はほとんど私たちの目的には関係ありませんが、この構造の最も重要な部分に注目してみましょう。</p>

<div class="label" id="code-signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.20</span> <span class="description"><a class="ref" href="./sign-up#fig-signup_form">図7.12</a>のフォームのHTMLソース。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span>
      <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
         <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span>
         <span class="na">name=</span><span class="s">&quot;user[password_confirmation]&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span>
         <span class="na">value=</span><span class="s">&quot;Create my account&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>(実は、このソースからは<em>信頼性トークン (authenticity token) </em>関連のHTMLを除外してあります。Railsは、ある種の<em>クロスサイトリクエスト偽造</em> (CSRF: cross-site request forgery) 攻撃に対抗するためにこのようなHTMLを自動的に追加します。動作の詳細や、この防御が重要な理由を知りたい場合は、Stack Overflowの<a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">Rails信頼性トークン関連の書き込み</a> (英語) を参照してください。</p>

<p>まずはこのHTMLソースの内部構造について説明します。<a class="ref" href="./sign-up#code-signup_form">リスト7.17</a>と<a class="ref" href="./sign-up#code-signup_form_html">リスト7.20</a>をじっくり見比べてみると、以下の埋め込みRubyは</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下のHTMLを生成していることがわかります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>さらに、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下のHTMLを生成していることがわかります。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up#fig-filled_in_form">図7.13</a>に示したように、テキストフィールド (<code>type=&quot;text&quot;</code>) では内容をそのまま表示していますが、パスワードフィールド (<code>type=&quot;password&quot;</code>) ではセキュリティ上の目的のために文字が隠蔽されています。<a class="ref" href="./sign-up#fig-filled_in_form"></a></p>

<div class="label" id="fig-filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/filled_in_form_bootstrap.png" alt="filled_in_form_bootstrap" /></span></div><div class="caption"><span class="header">図7.13</span><span class="description"><code>text</code>フィールドと<code>password</code>フィールドに文字を入力した状態。<a href="../images/figures/filled_in_form_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-up#sec-signup_success">7.4</a>でも説明しますが、ユーザーの作成で重要なのは<code>input</code>ごとにある特殊な<code>name</code>属性です。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_name&quot;</span> <span class="na">name=</span><span class="s">&quot;user[name]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Railsはこれらの<code>name</code>の値を使用して、初期化ハッシュを (<code>params</code>変数経由で) 構成します。このハッシュは、ユーザーが入力した値に基づいてユーザーを作成するとき (<a class="ref" href="./sign-up#sec-signup_failure">7.3</a>) に使用されます。</p>

<p>次に重要な要素は、<code>form</code>タグ自身です。Railsは<code>form</code>タグを作成するときに<code>@user</code>オブジェクトを使用します。すべてのRubyオブジェクトは自分のクラスを知っている (<a class="ref" href="/chapters/rails-flavored-ruby#sec-constructors">4.4.1</a>) ので、Railsは<code>@user</code>のクラスが<code>User</code>であることを知ることができます。また、<code>@user</code>は<em>新しい</em>ユーザーなので、 Railsは<code>post</code>メソッドを使用してフォームを構成する方法を知っています。これは新しいオブジェクトを作成するための正式な動詞 (verb) です (<a class="ref" href="/chapters/static-pages#sidebar-get_etc">コラム 3.3</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>ここで<code>class</code>と<code>id</code>属性はほぼ無関係です。ここで重要な属性は<code>action=&quot;/users&quot;</code>と<code>method=&quot;post&quot;</code>です。これらの2つの属性は、/usersというURLへのHTTP <tt>POST</tt>リクエストに対する指示を構成しています。これらの属性の効用については次の2つの節で説明します。</p>

<div class="label" id="sec-signup_failure"></div>


<h2><a id="sec-7_3" href="./sign-up#sec-signup_failure" class="heading"><span class="number">7.3</span>ユーザー登録失敗</a></h2>


<p><a class="ref" href="./sign-up#fig-signup_form">図7.12</a>ではフォームのHTMLがどうなっているかを簡単に説明しました (<a class="ref" href="./sign-up#code-signup_form_html">リスト7.20</a>参照) が、フォームを理解するには<em>ユーザー登録の失敗</em>のときが最も参考になります。この節では、無効なデータ送信を受け付けるユーザー登録フォームを作成し、ユーザー登録フォームを更新してエラーの一覧を表示します。このモックアップを<a class="ref" href="./sign-up#fig-signup_failure_mockup">図7.14</a>に示します。</p>

<div class="label" id="fig-signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_failure_mockup_bootstrap.png" alt="signup_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.14</span><span class="description">ユーザー登録が失敗したときのモックアップ。<a href="../images/figures/signup_failure_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-a_working_form"></div>


<h3><a id="sec-7_3_1" href="./sign-up#sec-a_working_form" class="heading"><span class="number">7.3.1</span>正しいフォーム</a></h3>


<p><a class="ref" href="./sign-up#sec-a_users_resource">7.1.2</a>で、<code>resources :users</code>を<code>routes.rb</code>ファイルに追加すると (<a class="ref" href="./sign-up#code-users_resource">リスト7.3</a>) 自動的にRailsアプリケーションが<a class="ref" href="./sign-up#table-RESTful_users">表7.1</a>のRESTful URI に応答するようになったことを思い出してください。特に、/usersへの<tt>POST</tt>リクエストは<code>create</code>アクションに送られます。私たちはここで、<code>create</code>アクションでフォーム送信を受け取り、<code>User.new</code>を使用して新しいユーザーオブジェクトを作成し、ユーザーを保存 (または保存に失敗) し、再度の送信用のユーザー登録ページを表示するという方法で機能を実装しようと思います。まずはユーザー登録フォームのコードを見直してみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up#sec-the_form_html">7.2.3</a>で説明したように、このHTMLは<tt>POST</tt>リクエストを /usersというURLに送信します。</p>

<p><a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>のコードがテストにパスするようにするためには、最初に<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>にある無効な情報をテストします。このリストでは、<a class="ref" href="/chapters/filling-in-the-layout#sec-partials">5.1.3</a>の「パーシャル」のところでも使った<code>render</code>メソッドを再度使いまわしています。<code>render</code>はコントローラのアクションの中でも正常に動作します。ここで、以前に説明した<code>if</code>-<code>else</code>分岐構造を思い出してください。この文を使用して、保存が成功したかどうかに応じて<code>@user.save</code>の値が<code>true</code>または<code>false</code> (<a class="ref" href="/chapters/modeling-users#sec-creating_user_objects">6.1.3</a>) になるときに、それぞれ成功時の処理と失敗時の処理を場合分けすることができます。</p>

<div class="label" id="code-first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.21</span> <span class="description">ユーザー登録の失敗に対応できる<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># 実装は終わっていないことに注意!</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># 保存の成功をここで扱う。</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コメントにもあるように、上のコードはまだ実装が完了していませんのでご注意ください。しかし実装の出発点としてはこれで十分です。実装は<a class="ref" href="./sign-up#sec-strong_parameters">7.3.2</a>で完了する予定です。</p>

<p><a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>のコードの動作を理解するもっともよい方法は、実際に無効なユーザー登録データを<em>送信 (submit)</em>してみることです。結果を<a class="ref" href="./sign-up#fig-signup_failure">図7.15</a>に、完全なデバッグ情報を<a class="ref" href="./sign-up#fig-signup_failure_rails_debug">図7.16</a>に示しました。</p>

<div class="label" id="fig-signup_failure"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_failure_rails_4.png" alt="signup_failure_rails_4" /></span></div><div class="caption"><span class="header">図7.15</span><span class="description">ユーザー登録失敗。<a href="../images/figures/signup_failure_rails_4-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_failure_rails_debug"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_failure_rails_4_debug.png" alt="signup_failure_rails_4_debug" /></span></div><div class="caption"><span class="header">図7.16</span><span class="description">ユーザー登録失敗時のデバッグ情報。<a href="../images/figures/signup_failure_rails_4_debug-full.png">(拡大)</a></span></div></div>


<p>Railsが送信を扱う方法をより深く理解するために、デバッグ情報のうちパラメーターハッシュの<code>user</code>の部分を詳しく見てみましょう (<a class="ref" href="./sign-up#fig-signup_failure_rails_debug">図7.16</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="s2">&quot;user&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;email&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;[FILTERED]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password_confirmation&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;[FILTERED]&quot;</span>
          <span class="p">}</span>
</pre></div>
</div>


<p>このハッシュはUsersコントローラに<code>params</code>として渡されます。<a class="ref" href="./sign-up#sec-a_users_resource">7.1.2</a>で説明したとおり、この<code>params</code>ハッシュには各リクエストの情報が含まれています。/users/1のようなURLの場合、<code>params[:id]</code>の値は該当するユーザーの<code>id</code> (この例では<code>1</code>) になります。ユーザー登録情報の送信の場合、<code>params</code>には複数のハッシュに対するハッシュ (hash-of-hashes: 入れ子になったハッシュ) が含まれます (なお、<a class="ref" href="/chapters/rails-flavored-ruby#sec-hashes_and_symbols">4.3.3</a>ではhash-of-hashesの説明とともに、コンソールセッションで使用するためにあえて<code>params</code>という名前の変数を導入しました)。上のデバッグ情報では、フォーム送信の結果が、送信された値に対応する属性とともに<code>user</code>ハッシュに保存されています。ハッシュのキーは、<code>input</code>タグの<code>name</code>属性です (<a class="ref" href="./sign-up#code-signup_form">リスト7.17</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p><code>&quot;user[email]&quot;</code>という名前は、<code>user</code>ハッシュの<code>email</code>属性を正確に指します。</p>

<p>ハッシュのキーはデバッグ情報では文字列として表現されていますが、Railsはこれらを文字列ではなく、<code>params[:user]</code>がuser属性のハッシュになるような「シンボル」(Rubyの機能の1つで、一意性が保証された特別な文字列) としてUsersコントローラに渡します。実際、<a class="ref" href="/chapters/rails-flavored-ruby#sec-a_user_class">4.4.5</a>で初めて使われ、<a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>でも使用されていたように、これらのハッシュは<code>User.new</code>の引数として必要な属性と正確に一致します。これはつまり、以下の行は</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>以下とほぼ等価であるということです。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">password:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>以前のバージョンのRailsでは、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>実際に動作しましたが、動作はデフォルトで不安定であり、悪意のあるユーザーによってアプリケーションのデータベースが書き換えられることのないように慎重な手続きによって使用しなければならず、しかもその手続はエラーを起こしやすいものでした。Rails 4.0では、上のコードはエラーになります (上の<a class="ref" href="./sign-up#fig-signup_failure">図7.15</a>および<a class="ref" href="./sign-up#fig-signup_failure_rails_debug">図7.16</a>を参照)。これにより、デフォルトでセキュリティが高められました。関連する以下のテストが失敗することを確認することで、このことをダブルチェックできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-strong_parameters"></div>


<h3><a id="sec-7_3_2" href="./sign-up#sec-strong_parameters" class="heading"><span class="number">7.3.2</span> Strong Parameters</a></h3>


<p><a class="ref" href="/chapters/rails-flavored-ruby#sec-a_user_class">4.4.5</a>で、<em>マスアサインメント</em>の概念について簡単に説明しました。これは、以下のように値のハッシュを使用してRubyの変数を初期化するものです。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>    <span class="c1"># 実装は終わっていないことに注意!</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>のコメントと、上の再録コメントでも重ねて指摘しているように、この実装は最終形ではありません。その理由は、<code>params</code>ハッシュ全体を初期化するという行為はセキュリティ上<em>きわめて</em>危険だからです。これは、ユーザーが送信したデータを<em>まるごと</em><code>User.new</code>に渡していることになります。ここで、Userモデルに<code>admin</code>属性というものがあるとしましょう。この属性は、Webサイトの管理者であるかどうかを示します (この属性を実装するのは<a class="ref" href="/chapters/updating-showing-and-deleting-users#sec-administrative_users">9.4.1</a>になってからです)。<code>admin=’1’</code>という値を<code>params[:user]</code>の一部に紛れ込ませて渡してしまえば、この属性を<code>true</code>にすることができます。これは<tt>curl</tt>などのコマンドベースのHTTPクライアントを使用すれば簡単に行うことができます。<code>params</code>ハッシュがまるごと<code>User.new</code>に渡されてしまうと、どのユーザーでも<code>admin=’1’</code>をWebリクエストに紛れ込ませるだけでWebサイトの管理者権限を奪い取ることができてしまいます。</p>

<p>以前のバージョンのRailsでは、<em>モデル</em>層で<code>attr_accessible</code>メソッドを使用することで上のような危険を防止していましたが、 Rails 4.0ではコントローラ層で<em>Strong Parameters</em>というテクニックを使用することが推奨されています。Strong Parametersを使用することで、<em>必須</em>のパラメータと<em>許可された</em>パラメータを指定することができます。さらに、上のように<code>params</code>ハッシュをまるごと渡すとエラーが発生するので、Railsはデフォルトでマスアサインメントの脆弱性から守られるようになりました。</p>

<p>この場合、<code>params</code>ハッシュでは<code>:user</code>属性を必須とし、名前、メールアドレス、パスワード、パスワードの確認の属性をそれぞれ許可し、それ以外を許可しないようにしたいと考えています。これは、以下のように記述することで行うことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
</pre></div>
</div>


<p>このコードの戻り値は、<code>params</code>ハッシュのバージョンと、許可された属性です (<code>:user</code>属性がない場合はエラーになります)。</p>

<p>これらのパラメータを使いやすくするために、<code>user_params</code>という外部メソッドを使用するのが慣習になっています。このメソッドは適切な初期化ハッシュを返します。このメソッドはUsersコントローラの内部でのみ実行され、Web経由で外部ユーザーにさらされる必要はないため、<a class="ref" href="./sign-up#code-create_action_strong_parameters">リスト7.22</a>に示すようにRubyの<code>private</code>キーワードを使用して<em>private</em>に設定します (<code>private</code>キーワードの詳細については <a class="ref" href="/chapters/sign-in-sign-out#sec-remember_me">8.2.1</a>で説明します)。</p>

<div class="label" id="code-create_action_strong_parameters"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.22</span> <span class="description"><code>create</code>アクションでStrong Parametersを使用する。</span><br /><span class="description"> <code>app/controller/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># 保存の成功をここで扱う。</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-up#code-create_action_strong_parameters">リスト7.22</a>のコードを使用することで、無効な送信のテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="go">-e &quot;signup with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-signup_error_messages"></div>


<h3><a id="sec-7_3_3" href="./sign-up#sec-signup_error_messages" class="heading"><span class="number">7.3.3</span>ユーザー登録のエラーメッセージ</a></h3>


<p>ユーザー登録に失敗した場合の最後の手順として、問題が生じたためにユーザー登録が行われなかったということをユーザーにわかりやすく伝えるエラーメッセージを追加しましょう。Railsは、このようなメッセージをUserモデルの検証時に自動的に生成してくれます。たとえば、ユーザー情報のメールアドレスが無効で、パスワードが短すぎる状態で保存しようとしたとします。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?</span><span class="gp">&gt; </span>                <span class="ss">password:</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>


<p><code>6.2.2</code>でも簡単に説明しましたが、<a class="ref" href="/chapters/modeling-users#sec-presence_validation">errors.full_messages</a>オブジェクトにはエラーメッセージの配列が含まれています。</p>

<p>上のコンソールセッションに示されているように、<a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>で保存に失敗すると、<code>@user</code>オブジェクトに関連付けられたエラーメッセージの一覧が生成されます。このメッセージをブラウザで表示するには、ユーザーの<code>new</code>ページでエラーメッセージのパーシャル (partial) を出力します。<a class="ref" href="./sign-up#code-f_error_messages">リスト7.23</a>に示します。(このエラーメッセージのテストを行うのはよいことですが、演習の課題としてあえて残しておきます。<a class="ref" href="./sign-up#sec-signup_exercises">7.6</a>を参照してください。) ここで使用しているエラーメッセージのパーシャルはあくまで試作品である点にご注意ください。最終版は<a class="ref" href="/chapters/user-microposts#sec-creating_microposts">10.3.2</a>を参照してください。</p>

<div class="label" id="code-f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.23</span> <span class="description">ユーザー登録フォームでエラーメッセージを表示するコード。</span><br /><span class="description"> <code>app/views/users/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>ここでは、<code>’shared/error_messages’</code>というパーシャルを<code>render</code> (レンダリング) している点にご注目ください。これはRails全般の慣習で、パーシャルは複数のコントローラにわたるビューに対し、専用の<code>shared/</code>ディレクトリを使用するようにしています (これは<a class="ref" href="/chapters/updating-showing-and-deleting-users#sec-edit_form">9.1.1</a>で実現します)。 つまり、<code>app/views/shared</code>ディレクトリと<code>_error_messages.html.erb</code>パーシャルファイルの両方を作成する必要があるということです。パーシャル自身の内容を<a class="ref" href="./sign-up#code-errors_partial">リスト7.24</a>に示します。</p>

<div class="label" id="code-errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.24</span> <span class="description">フォーム送信のエラーメッセージを表示するパーシャル。</span><br /><span class="description"> <code>app/views/shared/_error_messages.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>
      The form contains <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>.
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>* <span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>パーシャルによって、RailsとRubyには、Railsエラーオブジェクト用の2つのメソッドを含む多くの成果物が導入されました。最初は<code>count</code>メソッドを紹介します。これはエラーの数を返します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 2</span>
</pre></div>
</div>


<p>もう1つは<code>any?</code>メソッドです。これは<code>empty?</code>メソッドと互いに補完します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p><a class="ref" href="/chapters/rails-flavored-ruby#sec-objects_and_message_passing">4.2.3</a>では文字列に対して<code>empty?</code>メソッドを使用しましたが、Railsのエラーオブジェクトに対しても使用できます。オブジェクトが空の場合は<code>true</code>、 それ以外の場合は<code>false</code>を返します。<code>any?</code>メソッドはちょうど<code>empty?</code>と逆の動作で、要素が1つでもある場合は<code>true</code>、ない場合は<code>false</code>を返します (なお、これらの<code>count</code>、<code>empty?</code>、<code>any?</code>メソッドは、Rubyの配列に対してもそのまま使用できます。これは<a class="ref" href="/chapters/user-microposts#sec-showing_microposts">10.2</a>で応用する予定です)。</p>

<p>さらに、<code>pluralize</code>という英語専用のテキストヘルパーが新たに登場しています。このヘルパーはデフォルトではコンソールでは使用できませんが、<code>ActionView::Helpers::TextHelper</code>を経由して明示的にインクルードできます<sup class="footnote" id="fnref-7_9"><a href="./sign-up#fn-7_9">9</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="ss">ActionView::Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p><code>pluralize</code>の最初の引数に整数が与えられると、それに基づいて2番目の引数の英単語を複数形に変更したものを返します。このメソッドの背後には強力な<em>インフレクター (活用形生成) </em> があり、不規則活用を含むさまざまな単語を複数形にすることができます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p><code>pluralize</code>を使用することで、コードは以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>このコードはたとえば <code>&quot;0 errors&quot;</code>、<code>&quot;1 error&quot;</code>、<code>&quot;2 errors&quot;</code> などのように、エラーの数に応じて活用された単語を返します。これにより、<code>&quot;1 errors&quot;</code> のような英語の文法に合わない文字列を避けることができます (これは<a href="http://www.urbandictionary.com/define.php?term=interwebs">teh interwebs</a>にも載っている、どうしようもないほどよく見かけるエラーです)。</p>

<p><a class="ref" href="./sign-up#code-errors_partial">リスト7.24</a>には、エラーメッセージにスタイルを与えるためのCSS id <code>error_explanation</code>も含まれていることに注目してください (<a class="ref" href="/chapters/filling-in-the-layout#sec-custom_css">5.1.2</a>のCSSでスタイルidに「<code>#</code>」記号を使用していることも思い出してください)。さらにRailsは、エラーページにある、<code>div</code>で囲まれたエラーCSSクラス<code>field_with_errors</code>を適用しています。これらのラベルによって、<a class="ref" href="./sign-up#code-error_messages_css">リスト7.25</a>のようにエラーメッセージをSCSSで整形することができます。ここでは、Sassの<code>@extend</code>関数を使用してBootstrapの<code>control-group</code>と<code>error</code>の2つのクラスの機能をインクルードしています。その結果、送信失敗時のエラーメッセージは<a class="ref" href="./sign-up#fig-signup_error_messages">図7.17</a>のように赤の背景で囲まれるようになります。これらのメッセージはモデルの検証時に生成されるので、メールアドレスのスタイルやパスワードの最小文字列などを変更すると、メッセージも自動的に変更されます。</p>

<div class="label" id="code-error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.25</span> <span class="description">エラーメッセージにスタイルを与えるためのCSS。</span><br /><span class="description"> <code>app/assets/stylesheets/custom.css.scss</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>

<span class="o">/*</span> <span class="nt">forms</span> <span class="o">*/</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nc">.</span>
<span class="nn">#error_explanation</span> <span class="p">{</span>
  <span class="na">color</span><span class="o">:</span> <span class="mh">#f00</span><span class="p">;</span>
  <span class="nt">ul</span> <span class="p">{</span>
    <span class="na">list-style</span><span class="o">:</span> <span class="no">none</span><span class="p">;</span>
    <span class="na">margin</span><span class="o">:</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">18</span><span class="kt">px</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="o">@</span><span class="k">extend</span> <span class="nc">.control-group</span><span class="o">;</span>
  <span class="o">@</span><span class="nt">extend</span> <span class="nc">.error</span><span class="o">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig-signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_error_messages_bootstrap.png" alt="signup_error_messages_bootstrap" /></span></div><div class="caption"><span class="header">図7.17</span><span class="description">ユーザー登録失敗時のエラーメッセージ。<a href="../images/figures/signup_error_messages_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この節で達成した成果を確認するために、<a class="ref" href="./sign-up#code-basic_signup_tests">リスト7.16</a>のユーザー登録失敗のテストを再度実行し、ユーザー登録ページを表示して入力フィールドが空白のまま [Create my account] をクリックするという動作をテストしましょう。 テストの結果を<a class="ref" href="./sign-up#fig-blank_signup_password_digest">図7.18</a>に示します。今度は期待どおりテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with invalid information&quot;</span>
</pre></div>
</div>


<div class="label" id="fig-blank_signup_password_digest"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/blank_signup_password_digest_bootstrap_4_0.png" alt="blank_signup_password_digest_bootstrap_4_0" /></span></div><div class="caption"><span class="header">図7.18</span><span class="description"><a href="http://localhost:3000/signup">/signup</a>を表示して何も入力せずに [Create my account] をクリックする。<a href="../images/figures/blank_signup_password_digest_bootstrap_4_0-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-signup_success"></div>


<h2><a id="sec-7_4" href="./sign-up#sec-signup_success" class="heading"><span class="number">7.4</span>ユーザー登録成功</a></h2>


<p>無効なフォームの送信を扱えるようになったので、いよいよ新規ユーザーを実際にデータベースに保存できるようにし (もちろんフォームが有効な場合に)、ユーザー登録フォームを完成させましょう。まずは、ユーザーを保存できるようにします。保存に成功すると、ユーザー情報は自動的にデータベースに登録されます。次にブラウザの表示を<em>リダイレクト</em>して、登録されたユーザーのプロファイルを表示します。ついでにウェルカムメッセージも表示しましょう。モックアップを<a class="ref" href="./sign-up#fig-signup_success_mockup">図7.19</a>に示します。保存に失敗した場合は、単に<a class="ref" href="./sign-up#sec-signup_failure">7.3</a>で開発したとおりの動作が実行されます。</p>

<div class="label" id="fig-signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_success_mockup_bootstrap.png" alt="signup_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図7.19</span><span class="description">ユーザー登録に成功した画面のモックアップ。<a href="../images/figures/signup_success_mockup_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-the_finished_signup_form"></div>


<h3><a id="sec-7_4_1" href="./sign-up#sec-the_finished_signup_form" class="heading"><span class="number">7.4.1</span>登録フォームの完成</a></h3>


<p>ユーザー登録フォームを完成させるために、<a class="ref" href="./sign-up#code-first_create_action">リスト7.21</a>のコメントアウトされた部分にコードを書き、適切に動作するようにしましょう。現時点では、以下の有効な送信テストは失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/user_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signup with valid information&quot;</span>
</pre></div>
</div>


<p>Railsのデフォルトのアクションは対応するビューを表示するようになっていますが、<code>create</code>アクションに対応するビューのテンプレートがない (あるはずがありません) ため、テストに失敗します。ここでは、登録後に別のページを表示するようにし、そのページが新規作成されたユーザープロファイルであることがわかるようにします。正しいページが出力されているかどうかのテストは、演習に回すことにします (<a class="ref" href="./sign-up#sec-signup_exercises">7.6</a>)。アプリケーションのコードを<a class="ref" href="./sign-up#code-user_create_action">リスト7.26</a>に示します。</p>

<div class="label" id="code-user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">7.26</span> <span class="description">保存とリダイレクトを行う、userの<code>create</code>アクション。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>リダイレクトでは<code>user_url</code>を省略し、単に<code>redirect_to @user</code>と書けばユーザー表示ページに移動します。</p>

<p><a class="ref" href="./sign-up#code-user_create_action">リスト7.26</a>のコードを使用することで、ユーザー登録ページは完成し、動作するようになります。以下のテストを実行することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-the_flash"></div>


<h3><a id="sec-7_4_2" href="./sign-up#sec-the_flash" class="heading"><span class="number">7.4.2</span>flash</a></h3>


<p>いよいよブラウザで正しいユーザー情報を登録できるようになりましたが、その前にWebアプリケーションに常識的に備わっている機能を追加してみましょう。登録完了後に表示されるページにメッセージを表示し (この場合は新規ユーザーへのウェルカムメッセージ)、2度目以降にはそのページにメッセージを表示しないようにするというものです。Railsでは、こういう場合に<em>flash</em>という特殊な変数を使用できます。この変数はハッシュのように扱うことができます。<code>4.3.3</code>でコンソール上で実行した例を思い出してみてください。そこではあえて<a class="ref" href="/chapters/rails-flavored-ruby#sec-hashes_and_symbols">flash</a>と名付けたハッシュを使用してハッシュの値を列挙しました。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">success:</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">error:</span> <span class="s2">&quot;It failed.&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, error: &quot;It failed.&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?</span><span class="gp">&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed.</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-up#code-layout_flash">リスト7.27</a>のようにアプリケーションのレイアウトに含めれば、flash変数の内容をWebサイト全体にわたって表示できるようにすることもできます (このコードは、HTMLとERbがミックスされていて美しくありません。コードの改良については<a class="ref" href="./sign-up#sec-signup_exercises">7.6</a>で解説します)。</p>

<div class="label" id="code-layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.27</span> <span class="description"><code>flash</code>変数の内容をWebサイトのレイアウトに追加する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-up#code-layout_flash">リスト7.27</a>のコードは、flashの各要素に<code>div</code>タグを追加して整形し、CSSクラスを指定してメッセージの種類がわかるようにしています。たとえば、<code>flash[:success] = &quot;Welcome to the Sample App!&quot;</code>とする場合、以下のコードを実行すると</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-</span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下のHTMLが生成されます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>Welcome to the Sample App!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>(ハッシュの<code>:success</code>キーはシンボルである点にご注目ください。Rubyはシンボルを自動的に <code>&quot;success&quot;</code> という文字列に変換してからテンプレートに挿入します。) 使用するすべてのキーと値を列挙する理由は、他のフラッシュメッセージも使えるようにするためです。たとえば、<a class="ref" href="/chapters/sign-in-sign-out#sec-rendering_with_a_flash_message">8.1.5</a>では<code>flash[:error]</code>を使用してサインインに失敗したことを表すメッセージを表示します<sup class="footnote" id="fnref-7_10"><a href="./sign-up#fn-7_10">10</a></sup>。</p>

<p>フラッシュメッセージが正しく表示されているかどうかのテストは演習に回します (<a class="ref" href="./sign-up#sec-signup_exercises">7.6</a>)。<a class="ref" href="./sign-up#code-signup_flash">リスト7.28</a>のように、<code>create</code>アクションで<code>flash[:success]</code>にウェルカムメッセージを割り当てれば 、テストにパスするようになります。</p>

<div class="label" id="code-signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.28</span> <span class="description">ユーザー登録ページにフラッシュメッセージを追加する。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_params</span>
      <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span>
                                   <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-the_first_signup"></div>


<h3><a id="sec-7_4_3" href="./sign-up#sec-the_first_signup" class="heading"><span class="number">7.4.3</span>実際のユーザー登録</a></h3>


<p>ついに、ユーザー登録が完成しました。名前: “Rails Tutorial”、メールアドレス: “<tt>example@railstutorial.jp</tt>”とでも登録してみましょう。登録結果 (<a class="ref" href="./sign-up#fig-signup_flash">図7.20</a>)にはユーザー登録成功を示すウェルカムメッセージが、<code>success</code>クラスのさわやかな緑色の背景で表示されています。このクラスは<a class="ref" href="/chapters/filling-in-the-layout#sec-custom_css">5.1.2</a>のBootstrap CSSフレームワークのものです。(もしメールアドレスが既に使用されているというメッセージが表示されたら、<a class="ref" href="./sign-up#sec-signup_form">7.2</a>でやったようにRakeの<code>db:reset</code>を実行してデータベースをリセットしてください)。ユーザー表示ページを再度読み込むと、今度はフラッシュメッセージは表示されなくなりました (<a class="ref" href="./sign-up#fig-signup_flash_reloaded">図7.21</a>)。</p>

<div class="label" id="fig-signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_flash_bootstrap.png" alt="signup_flash_bootstrap" /></span></div><div class="caption"><span class="header">図7.20</span><span class="description">ユーザー登録が成功し、フラッシュメッセージが表示される。<a href="../images/figures/signup_flash_bootstrap-full.png">(拡大)</a></span></div></div>




<div class="label" id="fig-signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_flash_reloaded_bootstrap.png" alt="signup_flash_reloaded_bootstrap" /></span></div><div class="caption"><span class="header">図7.21</span><span class="description">ブラウザでページを再読み込みしてフラッシュメッセージが表示されなくなる。<a href="../images/figures/signup_flash_reloaded_bootstrap-full.png">(拡大)</a></span></div></div>


<p>今度はデータベースを覗いて、新規ユーザーが確かに登録されていることをダブルチェックしましょう。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="s2">&quot;example@railstutorial.jp&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, name: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.jp&quot;,</span>
<span class="go">created_at: &quot;2013-03-12 05:51:34&quot;, updated_at: &quot;2013-03-12 05:51:34&quot;,</span>
<span class="go">password_digest: &quot;$2a$10$A58/j7wwh3aAffGkMAO9Q.jjh3jshd.6akh...&quot;</span><span class="go">&gt;</span>
</pre></div>
</div>




<div class="label" id="sec-deploying_to_production_with_ssl"></div>


<h3><a id="sec-7_4_4" href="./sign-up#sec-deploying_to_production_with_ssl" class="heading"><span class="number">7.4.4</span> SSLを導入して本番環境をデプロイする</a></h3>


<p>Userモデルとユーザー登録機能の開発が終わったので、今度はこのサンプルアプリケーションを本番 (production) 環境にデプロイしましょう (<a class="ref" href="/chapters/static-pages#top">第3章</a>の設定を行なっていない場合は、今のうちに設定を行なっておいてください)。 デプロイの作業の1つとして、<a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">Secure Sockets Layer (SSL)</a><sup class="footnote" id="fnref-7_11"><a href="./sign-up#fn-7_11">11</a></sup>を本番アプリケーションに追加し、ユーザー登録をセキュアにします。SSLはWebサイト全体で有効にするので、サンプルアプリケーションのユーザー登録 (<a class="ref" href="/chapters/sign-in-sign-out#top">第8章</a>) もセキュアになり、<em>セッションハイジャック</em>の脆弱性を防止できます (<a class="ref" href="/chapters/sign-in-sign-out#sec-remember_me">8.2.1</a>)。</p>

<p>デプロイの下準備として、この時点で変更を<code>master</code>ブランチにマージしておきます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish user signup&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-up
</pre></div>
</div>


<p>デプロイされたアプリケーションが期待どおりに動作するために、SSLが本番環境で動作するための行を1つ追加します。そのためには、<code>config/environments/production.rb</code>ファイルを <a class="ref" href="./sign-up#code-ssl_in_production">リスト7.29</a>のように変更します。</p>

<div class="label" id="code-ssl_in_production"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.29</span> <span class="description">本番環境のアプリケーションでSSLを有効にする。</span><br /><span class="description"> <code>config/environments/production.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security,</span>
  <span class="c1"># and use secure cookies.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">force_ssl</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>本番Webサイトが動作するために、設定ファイルの変更をコミットしてHerokuにプッシュする必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git commit -a -m <span class="s2">&quot;Add SSL in production&quot;</span>
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>次に、本番データベースでマイグレーションを実行し、HerokuにUserデータモデルを使用することを通知します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<p>(ここでいくつか警告メッセージが表示されることがありますが、無視しても構いません。)</p>

<p>最後に、リモートサーバーでSSLを設定します。本番WebサイトでSSLを使用するように設定を行うのはかなり面倒で、間違いも起きやすくなっています。また、使用する独自ドメイン向けの<em>SSL証明書</em>も購入しなければなりません。幸い、このサンプルアプリケーションのようにHerokuドメインのまま使用してもよいのであれば、HerokuのSSL証明書を流用することができます。これはHerokuプラットフォームの一部として自動的に利用できる機能です。SSLを<code>example.com</code>のような独自ドメインで実行したいのであれば、SSL証明書を購入するしかありません。詳細は<a href="http://devcenter.heroku.com/articles/ssl">HerokuのSSL関連ページ</a>を参照してください。</p>

<p>これでいよいよ、以下を実行して本番サーバーでユーザー登録フォームが動作するところをブラウザで見ることができます (<a class="ref" href="./sign-up#fig-signup_in_production">図7.22</a>)。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku open
</pre></div>
</div>


<p><a class="ref" href="./sign-up#fig-signup_in_production">図7.22</a>では、通常の<tt>http://</tt>ではなく<tt>https://</tt>になっていることにご注目ください。この余分な ‘s’ はSSLが有効であることを表しています。</p>

<p>これで、好きなだけユーザー登録ページを表示して新規ユーザーを作成できるようになりました。何か問題が生じた場合は、以下を実行して</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku logs
</pre></div>
</div>


<p>Herokuのログファイルを使用してエラーをデバッグします。</p>

<div class="label" id="fig-signup_in_production"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signup_in_production_bootstrap.png" alt="signup_in_production_bootstrap" /></span></div><div class="caption"><span class="header">図7.22</span><span class="description">本番Webで動作中のユーザー登録ページ。 <a href="../images/figures/signup_in_production_bootstrap-full.png">(拡大)</a></span></div></div>




<h2><a id="sec-7_5" href="./sign-up#sec-7_5" class="heading"><span class="number">7.5</span>最後に</a></h2>


<p>ユーザー登録機能の実装は、私たちのサンプルアプリケーションにとって大きなマイルストーンでした。この時点でサンプルアプリケーションはかなり実用的になってきましたが、まだ重要な機能がいくつも残っています。<a class="ref" href="/chapters/sign-in-sign-out#top">第8章</a>では、認証 (authentication) システムを導入し、ユーザーがサインインとサインアウトを行えるようにします。<a class="ref" href="/chapters/updating-showing-and-deleting-users#top">第9章</a>では、どのユーザーも自分のアカウント情報を更新できるようにし、Webサイトの管理者がユーザーを削除できるようにします。それにより、Usersリソースに<a class="ref" href="./sign-up#table-RESTful_users">表7.1</a>のRESTアクションがすべて実装されるようにします。最後に、認可 (authorization) のためのメソッドをアクションに追加し、Webサイトがセキュリティモデルに従うようにします。</p>

<div class="label" id="sec-signup_exercises"></div>


<h2><a id="sec-7_6" href="./sign-up#sec-signup_exercises" class="heading"><span class="number">7.6</span>演習</a></h2>




<ol>

<li><a class="ref" href="./sign-up#code-gravatar_option">リスト7.30</a>のコードを使用して、<a class="ref" href="./sign-up#sec-a_gravatar_image">7.1.4</a>で定義された<code>gravatar_for</code>ヘルパーにオプションの<code>size</code>パラメーターを取ることができる (<code>gravatar_for user, size: 40</code>のようなコードをビューで使用できる) ことを確認してください。</li>

<li><a class="ref" href="./sign-up#code-f_error_messages">リスト7.23</a>で実装したエラーメッセージをテストするコードを書いてください。<a class="ref" href="./sign-up#code-error_messages_test">リスト7.31</a>のように書き始めるのがお勧めです。</li>

<li><a class="ref" href="./sign-up#code-after_save_tests">リスト7.32</a>のテストが、<code>create</code>アクションでユーザーを保存した後の動作を正しく捉えていることを確認してください。確認方法は、最初にテストを書いてもよいし、アプリケーションのコードをわざと壊してその後修正しても構いません。<a class="ref" href="./sign-up#code-after_save_tests">リスト7.32</a>では、Capybaraの<code>have_selector</code>メソッドを導入しています。これは (特定のCSSクラスに属する) 特定のHTMLタグが存在しているかどうかをテストします。</li>

<li>既に書いたとおり、<a class="ref" href="./sign-up#code-layout_flash">リスト7.27</a>のコードは美しいとは言えません。より読みやすくした<a class="ref" href="./sign-up#code-layout_flash_content_tag">リスト7.33</a>のコードに対してテストスイートを実行し、こちらも正常に動作することを確認してください。このコードでは、Railsの<code>content_tag</code>ヘルパーを使用しています。</li>

</ol>




<div class="label" id="code-gravatar_option"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.30</span> <span class="description"><code>gravatar_for</code>ヘルパー用のオプションの<code>:size</code>パラメーターを定義する。</span><br /><span class="description"> <code>app/helpers/users_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="c1"># Returns the Gravatar (http://gravatar.com/) for the given user.</span>
  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">size:</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_id</span> <span class="o">=</span> <span class="ss">Digest::MD5</span><span class="o">::</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:size</span><span class="o">]</span>
    <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;https://secure.gravatar.com/avatar/</span><span class="si">#{</span><span class="n">gravatar_id</span><span class="si">}</span><span class="s2">?</span><span class="s2">s=</span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="n">gravatar_url</span><span class="p">,</span> <span class="ss">alt:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code-error_messages_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.31</span> <span class="description">お勧めのエラーメッセージテスト。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre>  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signup_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after submission&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign up&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code-after_save_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.32</span> <span class="description"><code>create</code>アクションで保存が行われた後の動作をテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre>    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Welcome&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
</pre></div>
</div></div>




<div class="label" id="code-layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト7.33</span> <span class="description">サイトのレイアウトにある<code>flash</code> ERbで<code>content_tag</code>を使用する。</span><br /><span class="description"> <code>app/views/layouts/application.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!</span><span class="cp">DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;alert alert-</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="/chapters/modeling-users#top">
</a><a class="prev_page" href="/chapters/modeling-users#top">    « <span class="number">第6章</span>ユーザーのモデルを作成する
</a><a class="prev_page" href="/chapters/modeling-users#top">  </a>
  <a class="next_page" href="/chapters/sign-in-sign-out#top">
</a><a class="next_page" href="/chapters/sign-in-sign-out#top">    <span class="number">第8章</span>サインイン、サインアウト »
</a><a class="next_page" href="/chapters/sign-in-sign-out#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-7_1"><a href="http://gomockingbird.com/">Mockingbird</a>では<a class="ref" href="./sign-up#fig-profile_mockup_profile_name">図7.1</a>のプロファイル写真のようなカスタム画像はサポートされていません。ここでは<a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>を使用して手動で画像を置きました。<a class="arrow" href="./sign-up#fnref-7_1">↑</a></li>
<li id="fn-7_2">このカバの写真は<a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>から引用しました。<a class="arrow" href="./sign-up#fnref-7_2">↑</a></li>
<li id="fn-7_3">Railsの<code>debug</code>情報は <a href="http://www.yaml.org/">YAML</a> (一種の<a href="http://catb.org/jargon/html/R/recursive-acronym.html">再帰的略語</a>であり、“YAML Ain’t Markup Language” の略とされています) 形式で表示されます。YAMLは人間<em>だけでなく</em>コンピュータにとっても読みやすい形式です。<a class="arrow" href="./sign-up#fnref-7_3">↑</a></li>
<li id="fn-7_4">実は、この3つ以外にもカスタムの環境を作成することができます。詳細については「<a href="http://railscasts.com/episodes/72-adding-an-environment">環境を追加した場合のRailsCast</a> (英語)」を参照してください。<a class="arrow" href="./sign-up#fnref-7_4">↑</a></li>
<li id="fn-7_5">この時点では、<em>ルーティング</em>は動作していますが、対応するページが動作しているとは限りません。たとえば、/users/1/edit がUsersコントローラの<code>edit</code>アクションに正常にルーティングされているとしても、<code>edit</code>アクションが存在しなければ、このURLにアクセスしたときにエラーになります。<a class="arrow" href="./sign-up#fnref-7_5">↑</a></li>
<li id="fn-7_6">ヒンズー教では、アバターは人間や動物の形をとって神が顕現したものと考えられています。これを拡大解釈して、<em>アバター</em>という用語は、特にネット界隈で、その人物を表現するもの (かつその人そのものの一部でもある) という意味で使われます。もちろん、映画「<a href="http://www.imdb.com/title/tt0499549/">アバター</a>」を見た人にはこんな解説は不要でしょう。<a class="arrow" href="./sign-up#fnref-7_6">↑</a></li>
<li id="fn-7_7">アプリケーションでカスタム画像を扱ったりその他のファイルをアップロードする必要がなければ、代わりに<a href="https://github.com/thoughtbot/paperclip">Paperclip</a> gemか<a href="https://github.com/jnicklas/carrierwave">CarrierWave</a> gemをお勧めします。<a class="arrow" href="./sign-up#fnref-7_7">↑</a></li>
<li id="fn-7_8">どうにも気持ちの悪い動作だと思いませんか。私はどちらもやりません。<a class="arrow" href="./sign-up#fnref-7_8">↑</a></li>
<li id="fn-7_9">私は<code>Rails API</code>で<a href="http://api.rubyonrails.org/v4.0.0/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize">pluralize</a>を調べていてたまたま気付きました。<a class="arrow" href="./sign-up#fnref-7_9">↑</a></li>
<li id="fn-7_10">実際には、これに非常に近い<code>flash.now</code>を使いますが、本当に必要になるまでは使わないようにしようかと思います。<a class="arrow" href="./sign-up#fnref-7_10">↑</a></li>
<li id="fn-7_11">技術上は、SSLはTLS (Transport Layer Security) と名称が変わりましたが、未だに “SSL” と呼ばれ続けています。<a class="arrow" href="./sign-up#fnref-7_11">↑</a></li>
</ol>
</div>




    </div>
  </body>
</html>
