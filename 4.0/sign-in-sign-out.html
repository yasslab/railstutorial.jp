<html dir="ltr" dir="ltr">
  <head>
    <title>beginning</title>
    
    <link rel="stylesheet" href="../stylesheets/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../stylesheets/polytexnic.css" type="text/css" />
  </head>
  <body dir="ltr" dir="ltr">
    <div id="book">

<div id="top"></div>


<h1 class="chapter"><a id="sec-8" href="./sign-in-sign-out.html#top" class="heading"><span class="number">第8章</span>サインイン、サインアウト
</a></h1>


<p><a class="ref" href="./sign-up.html#top">第7章</a>でWebサイトでの新規ユーザー登録が行えるようになりましたので、今度はユーザーがサインインとサインアウトを行えるようにしましょう。これにより、サインインの状態と現在のユーザーidに応じて動作を変更できるようになります。たとえば、この章では、サイトのヘッダー部分にサインイン／サインアウトのリンクとプロファイルへのリンクを表示するようにします。<a class="ref" href="./user-microposts.html#top">第10章</a>では、サインインしたユーザーidを使用して、そのユーザーに関連付けられたマイクロポストを作成します。また<a class="ref" href="./following-users.html#top">第11章</a>では、現在のユーザーが他のユーザーをフォローして、マイクロポストのフィードを受け取ることができるようにします。</p>

<p>ユーザーがサインインすることでセキュリティモデルも実装され、サインインしているユーザーidに基づいて、特定のページへのアクセスを制限することもできます。<a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>でも説明しますが、たとえばサインインしたユーザーのみがユーザー情報編集ページにアクセスできるようにします。サインインシステムを使用して、管理者ユーザーに特別な権限を与えることもできます。たとえば (<a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>で導入する) データベースからユーザーを削除する機能があります。</p>

<p>コアとなる認証機能を実装した後は、少々回り道して、振舞駆動開発 (<a class="ref" href="./sign-in-sign-out.html#sec-cucumber">8.3</a>) で有名な<em>Cucumber</em>というツールを試してみます。特に、2つの開発手法を比較するために、RSpecによる結合テストの組み合わせをCucumberで再実装します。</p>

<p>前章同様に、トピックブランチで作業してから、最後に更新をマージします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec-signin_failure"></div>


<h2><a id="sec-8_1" href="./sign-in-sign-out.html#sec-signin_failure" class="heading"><span class="number">8.1</span>セッション、サインインの失敗</a></h2>


<p><a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>セッション</em></a>とは、2つのコンピュータの間、たとえばクライアント側のブラウザとサーバーで動作しているRailsとの間の、半永続的な接続のことです。ここでは、”サインイン” の共通パターンを実装するためにセッションを使用します。ここで、Webの世界にはセッションの振る舞いを表現するためのいくつかの異なったモデルがあります。ブラウザを閉じるとセッションを終了する「忘却モデル」、[パスワードを保存する] チェックボックスを使用してセッションを継続する「継続モデル」、ユーザーが明示的にサインアウトするまでセッションを継続する「永続モデル」などです<sup class="footnote" id="fnref-8_1"><a href="./sign-in-sign-out.html#fn-8_1">1</a></sup>。ここでは、最後の永続モデルを採用することにします。ユーザーがサインインすると、ユーザーが明示的にサインアウトするまでサインインの状態を永続させます (<a class="ref" href="./sign-in-sign-out.html#sec-remember_me">8.2.1</a>では、“永続” が実際にはどのぐらいの時間であるかをお見せします)。</p>

<p>セッションは、RESTfulなリソースとして作成しておくと便利です。たとえばサインインページを<em>new</em>セッションで、サインインを<em>create</em>セッションで、サインアウトを<em>destroy</em>セッションでそれぞれ扱います。Usersリソースのように (Usersモデルを経由して) データベースをバックエンドに持つリソースとは異なり、このSessionsリソースでは<a href="http://en.wikipedia.org/wiki/HTTP_cookie"><em>cookies</em></a>を使用します。cookiesとは、ブラウザに保存される小さなテキストデータです。サインイン関連の作業の大半は、このcookiesをベースにして認証システムを構築することになります。この節と次の節では、セッション機能を作成する準備として、Sessionコントローラ、サインイン用のフォーム、そしてこれらに関連するコントローラのアクションを作成します。次の<a class="ref" href="./sign-in-sign-out.html#sec-signin_success">8.2</a>では、cookies管理のために必要なコードを追加して、ユーザーがサインインするための仕組みを完成させます。 </p>

<div class="label" id="sec-sessions_controller"></div>


<h3><a id="sec-8_1_1" href="./sign-in-sign-out.html#sec-sessions_controller" class="heading"><span class="number">8.1.1</span> Sessionコントローラ</a></h3>


<p>サインインとサインアウトの要素は、Sessionsコントローラの特定のRESTアクションにそれぞれ対応します。サインインのフォームは、この節の<code>new</code>アクションで処理されます。実際のサインイン処理は、<code>create</code>アクションに<tt>POST</tt>リクエストが送信されたときに処理されます (<a class="ref" href="./sign-in-sign-out.html#sec-signin_failure">8.1</a>および<a class="ref" href="./sign-in-sign-out.html#sec-signin_success">8.2</a>) 。サインアウトは、<code>destroy</code>アクションに<tt>DELETE</tt>リクエストを送信することで処理されます(<a class="ref" href="./sign-in-sign-out.html#sec-signing_out">8.2.6</a>)。(<a class="ref" href="./sign-up.html#table-RESTful_users">表7.1</a>のHTTPメソッドとRESTアクションの関連付けを思い出してください。) それでは最初に、Sessionsコントローラと認証システムをテストする結合テストを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions --no-test-framework
<span class="gp">$</span> rails generate integration_test authentication_pages
</pre></div>
</div>


<p><a class="ref" href="./sign-up.html#sec-signup_form">7.2</a>で作成したユーザー登録ページのモデルを元に、新しいセッションを確立するためのフォームを<a class="ref" href="./sign-in-sign-out.html#fig-signin_mockup">図8.1</a>のモックアップに従って作成します。</p>

<div class="label" id="fig-signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signin_mockup_bootstrap.png" alt="signin_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.1</span><span class="description">サインインフォームのモックアップ。<a href="../images/figures/signin_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>このサインインページは、<code>signin_path</code>によって仮に定義されるURLでアクセス可能になります。<a class="ref" href="./sign-in-sign-out.html#code-new_session_tests">リスト8.1</a>のように、最初は最小限のテストから始めます (<a class="ref" href="./sign-up.html#code-initial_signup_test">リスト7.6</a>のユーザー登録ページのコードと似ているので、比較してみてください)。</p>

<div class="label" id="code-new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.1</span> <span class="description">セッションの<code>new</code>アクションとビューをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin page&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>以下のテストは、この時点では失敗するはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
 </pre></div>
</div>


<p><a class="ref" href="./sign-in-sign-out.html#code-new_session_tests">リスト8.1</a>のテストがパスするためには、サインインページ用にカスタマイズした名前付きルートを使用して、Sessionsリソースのルーティングを定義する必要があります。このサインインページはSessionコントローラの<code>new</code>アクションと対応しています。Usersリソースの場合と同様に、<code>resources</code>メソッドを使用して通常のRESTfulなルーティングを設定することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</pre></div>
</div>


<p>セッションを編集したりユーザーに表示したりする必要がないので、<code>resources</code>メソッドに<code>:only</code>オプションを追加し、<code>new</code>、<code>create</code>、<code>destroy</code>の3つのアクションのみを有効にします。サインインとサインアウト用のルーティングを含む完全なコードを<a class="ref" href="./sign-in-sign-out.html#code-sessions_resource">リスト8.2</a>に示します。</p>

<div class="label" id="code-sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.2</span> <span class="description">リソースを追加して標準のRESTfulアクションを設定する。</span><br /><span class="description"> <code>config/routes.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="ss">SampleApp::Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">only:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">root</span>  <span class="s1">&#39;static_pages#home&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;users#new&#39;</span><span class="p">,</span>            <span class="ss">via:</span> <span class="s1">&#39;get&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signin&#39;</span><span class="p">,</span>  <span class="ss">to:</span> <span class="s1">&#39;sessions#new&#39;</span><span class="p">,</span>         <span class="ss">via:</span> <span class="s1">&#39;get&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signout&#39;</span><span class="p">,</span> <span class="ss">to:</span> <span class="s1">&#39;sessions#destroy&#39;</span><span class="p">,</span>     <span class="ss">via:</span> <span class="s1">&#39;delete&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>注: サインアウトのルーティングにある<code>via: ’delete’</code>は、このアクションが HTTPの<tt>DELETE</tt>リクエストによって呼び出されることを示しています。</p>

<p><a class="ref" href="./sign-in-sign-out.html#code-sessions_resource">リスト8.2</a>で定義されたリソースは、<a class="ref" href="./sign-in-sign-out.html#table-RESTful_sessions">表8.1</a>に示したように、<a class="ref" href="./sign-up.html#table-RESTful_users">表7.1</a>とよく似たURLとアクションを提供します。注：サインインとサインアウトのアクションのルーティングはカスタムで設定しますが、セッションの生成アクションへのルーティングはデフォルトを使います (i.e., <code>[resource name]_path</code>).</p>

<div class="label" id="table-RESTful_sessions"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>HTTPリクエスト</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>名前付きルート</strong></th><th class="align_left"><strong>アクション</strong></th><th class="align_left"><strong>用途</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left">/signin</td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">新しいセッション用 (サインイン)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left">/sessions</td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">新しいセッションを作成する</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left">/signout</td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">セッションを削除する (サインアウト)</td></tr></table></div><div class="caption"><span class="header">表8.1</span><span class="description"><a class="ref" href="./sign-in-sign-out.html#code-sessions_resource">リスト8.2</a>のセッションルールによって提供されるRESTfulなルート。</span></div></div>


<p>次に、<a class="ref" href="./sign-in-sign-out.html#code-new_session_tests">リスト8.1</a>のテストがパスするようにするために、<a class="ref" href="./sign-in-sign-out.html#code-new_session_title">リスト8.3</a>に示したように<code>new</code>アクションをSessionsコントローラに追加します (後で使えるよう<code>create</code>アクションと<code>destroy</code>アクションも定義しておきます) 。</p>

<div class="label" id="code-new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.3</span> <span class="description">最初のSessionsコントローラ。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>最後に、サインインページを新規に定義します。このページは新規セッション用なので、今から作成するサインインページを<code>app/views/sessions/new.html.erb</code>に置くことに注目してください。<a class="ref" href="./sign-in-sign-out.html#code-initial_signin_page">リスト8.4</a>に示したように、今の時点ではタイトルと一番上のヘッダ部分のみを定義します。</p>

<div class="label" id="code-initial_signin_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.4</span> <span class="description">最初のサインインビュー。</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>これにより、<a class="ref" href="./sign-in-sign-out.html#code-new_session_tests">リスト8.1</a>のテストが青信号 (成功) になります。これで実際のサインインフォームを作成する準備ができました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>




<div class="label" id="sec-signin_tests"></div>


<h3><a id="sec-8_1_2" href="./sign-in-sign-out.html#sec-signin_tests" class="heading"><span class="number">8.1.2</span>サインインをテストする</a></h3>


<p><a class="ref" href="./sign-in-sign-out.html#fig-signin_mockup">図8.1</a>と<a class="ref" href="./sign-up.html#fig-signup_mockup">図7.11</a>を比較すると、サインインフォーム (新規セッションフォーム) の外観は、4つあったフィールドがメールアドレスとパスワードの2つになったこと以外は、ユーザー登録フォームによく似ていることに気付くと思います。ユーザー登録フォームのときと同様に、サインインフォームでもCapybaraを使ってフォームに値を入力し、ボタンをクリックするテストを行うことができます。</p>

<p>テストを作成していると、私たちはアプリケーションをさまざまな側面から設計することを強いられます。これはテスト駆動開発の素晴らしい副次的効果のひとつです。<a class="ref" href="./sign-in-sign-out.html#fig-signin_failure_mockup">図8.2</a>のモックアップで示されているように、最初はサインインの入力に誤りがあった場合のテストから作成します。</p>

<div class="label" id="fig-signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signin_failure_mockup_bootstrap.png" alt="signin_failure_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.2</span><span class="description">サインイン失敗時のモックアップ。<a href="../images/figures/signin_failure_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-in-sign-out.html#fig-signin_failure_mockup">図 8.2</a>に示されているように、サインインで入力した情報に誤りがあったときは、サインインページをもう一度表示して、エラーメッセージを出力します。ここではエラーをフラッシュメッセージとして表示するので、以下のようにテストできます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>上のコードでは、<a class="ref" href="./sign-up.html#code-after_save_tests">リスト7.32</a>で導入したCapybaraの<code>have_selector</code>メソッドを使用しています (<a class="ref" href="./sign-up.html#top">第7章</a>の演習)。<code>have_selector</code>メソッドは、特定のセレクタ要素 (HTMLタグなど) があるかどうかをチェックします。なお、Capybara 2.0では<em>画面に表示される要素</em>しかチェックできません。セレクタ要素（つまりタグ）は以下のように指定します。</p>

<div class="code"><div class="highlight"><pre><span class="n">div</span><span class="o">.</span><span class="n">alert</span><span class="o">.</span><span class="n">alert</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>


<p>上のコードは<code>div</code>タグがあるかどうかをチェックします。上のコードのドットはCSSのクラスを意味することを思い出してください (<a class="ref" href="./filling-in-the-layout.html#sec-custom_css">5.1.2</a>) 。つまりこのテストでは、<code>&quot;alert&quot;</code>クラスと<code>&quot;alert-error&quot;</code>クラスの<code>div</code>タグを対象にしていることがわかります。また、エラーメッセージに<code>&quot;Invalid&quot;</code>という単語が含まれていることもテストします。これらを合わせると、次のフォームの要素を探しだしてテストが行われます。</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-error&quot;</span><span class="nt">&gt;</span>Invalid...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-in-sign-out.html#code-initial_failing_signin_test">リスト 8.5</a>のコードは、タイトルとフラッシュメッセージをまとめてテストします。ただしこのテストは、実はある重要な点を欠いています。これは<a class="ref" href="./sign-in-sign-out.html#sec-rendering_with_a_flash_message">8.1.5</a>で改善します。</p>

<div class="label" id="code-initial_failing_signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.5</span> <span class="description">サインイン失敗時のテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>サインインに失敗した時のテストができたので、次はサインインに成功した場合のテストを作成しましょう。ユーザープロファイルページが表示されること (ページタイトルがユーザー名になっていること)、サイトのナビゲーションに次の3つの変更が加えられていることを確認するよう、テストを変更します。</p>

<ol>
<li>プロファイルページヘのリンクの表示</li>
<li>[Sign out] リンクの表示</li>
<li>[Sign in] リンクの非表示</li>
</ol>


<p>([Setting] リンクについては<a class="ref" href="./updating-showing-and-deleting-users.html#sec-updating_users">9.1</a>で、[Users] リンクについては<a class="ref" href="./updating-showing-and-deleting-users.html#sec-showing_all_users">9.3</a>でそれぞれテストします) 。これらの変更を加えたモックアップを<a class="ref" href="./sign-in-sign-out.html#fig-signin_success_mockup">図8.3</a>に示しました<sup class="footnote" id="fnref-8_2"><a href="./sign-in-sign-out.html#fn-8_2">2</a></sup>。サインアウトとプロファイルページヘのリンクは、[Account] メニューにドロップダウンで表示されます。Bootstrapを使用してドロップダウンメニューを作成する方法については<a class="ref" href="./sign-in-sign-out.html#sec-changing_the_layout_links">8.2.4</a>で説明します。</p>

<div class="label" id="fig-signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signin_success_mockup_bootstrap.png" alt="signin_success_mockup_bootstrap" /></span></div><div class="caption"><span class="header">図8.3</span><span class="description">サインインに成功後表示されるユーザープロファイルのモックアップ。<a href="../images/figures/signin_success_mockup_bootstrap-full.png">(拡大)</a></span></div></div>


<p>サインインに成功したときのテストコードを<a class="ref" href="./sign-in-sign-out.html#code-signin_success_tests">リスト8.6</a>に示しました。</p>

<div class="label" id="code-signin_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.6</span> <span class="description">サインインに成功したときのテスト。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、Capybaraの<code>have_link</code>メソッドが導入されています。このメソッドは、リンクテキストを引数にとります。オプションとして次のように<code>:href</code>パラメータを加えると、</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
</pre></div>
</div>


<p>アンカータグ<code>a</code>に<code>href</code> (URL) 属性を追加することもできます (この例では、ユーザープロファイルへのリンク)。上のテストでは、<code>upcase</code>メソッドを使用してユーザーのメールアドレスを大文字に変換することで、大文字小文字を区別しないデータベースが使用されている場合であってもユーザーを確実に検索できるように配慮してあることに注目してください。</p>

<div class="label" id="sec-signin_form"></div>


<h3><a id="sec-8_1_3" href="./sign-in-sign-out.html#sec-signin_form" class="heading"><span class="number">8.1.3</span>サインインのフォーム</a></h3>


<p>テストの準備が完了したので、いよいよサインインフォームの開発に取りかかりましょう。<a class="ref" href="./sign-up.html#code-signup_form">リスト7.17</a>のときは、以下のようにユーザー登録フォームで<code>form_for</code>ヘルパーを使用し、ユーザーのインスタンス変数 <code>@user</code>を引数にとっていました。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>このユーザー登録フォームとサインインフォームの主な違いは、サインインフォームにはSessionモデルがないために<code>@user</code>変数のような存在がないことです。 これはつまり、新しいセッションフォームを作成するときに<code>form_for</code>ヘルパーに追加の情報を渡す必要があるということです。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>Railsは上の場合、フォームの<code>action</code>は/usersというURLへの<tt>POST</tt>であると自動的に判定しますが、セッションの場合はリソースの<em>名前</em>とそれに対応するURLを指定する必要があります。</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>(注: <code>form_for</code>の代わりに<code>form_tag</code>を使うこともでき、Railsではこの方が慣用的な方法です。しかし、ユーザー登録フォームではform_forを使用する方が一般的であり、並列構造を強調するためにもform_forを使用しました。<code>form_tag</code>を使ったフォームについては(<a class="ref" href="./sign-in-sign-out.html#sec-sign_in_out_exercises">8.5</a>)の演習に回します。)</p>

<p>適切な<code>form_for</code>を使用することで、<a class="ref" href="./sign-up.html#code-signup_form">リスト7.17</a>のユーザー登録フォームを参考にして、<a class="ref" href="./sign-in-sign-out.html#code-signin_form">リスト8.7</a>に示したようなモックアップに従ったサインインフォームを簡単に作成できます (<a class="ref" href="./sign-in-sign-out.html#fig-signin_mockup">図8.1</a>)。</p>

<div class="label" id="code-signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.7</span> <span class="description">サインインフォームのコード。</span><br /><span class="description"> <code>app/views/sessions/new.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">provide</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span6 offset3&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">url:</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>

      <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="ss">class:</span> <span class="s2">&quot;btn btn-large btn-primary&quot;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

    <span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>ユーザーにとって便利なように、ユーザー登録ページのリンクを追加してあることに注目してください。<a class="ref" href="./sign-in-sign-out.html#code-signin_form">リスト 8.7</a>のコードで生成されるサインインフォームを<a class="ref" href="./sign-in-sign-out.html#fig-signin_form">図 8.4</a>に示します。</p>

<div class="label" id="fig-signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/signin_form_bootstrap.png" alt="signin_form_bootstrap" /></span></div><div class="caption"><span class="header">図8.4</span><span class="description">サインインフォーム  (<a href="http://localhost:3000/signin">/signin</a>)。<a href="../images/figures/signin_form_bootstrap-full.png">(拡大)</a></span></div></div>


<p>これまではRailsが生成したHTMLをブラウザでたびたび確認していた方も多いと思いますが、やがてその習慣は忘れ去られ、ヘルパーが正常に動作していることを信頼するようになる日が来ることでしょう。今はいつものように(<a class="ref" href="./sign-in-sign-out.html#code-signin_form_html">リスト 8.8</a>)を見てみましょう。</p>

<div class="label" id="code-signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.8</span> <span class="description"><a class="ref" href="./sign-in-sign-out.html#code-signin_form">リスト8.7</a>で生成されたサインインフォームのHTML。</span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">accept-charset=</span><span class="s">&quot;UTF-8&quot;</span> <span class="na">action=</span><span class="s">&quot;/sessions&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_email&quot;</span> <span class="na">name=</span><span class="s">&quot;session[email]&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_password&quot;</span> <span class="na">name=</span><span class="s">&quot;session[password]&quot;</span>
           <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">class=</span><span class="s">&quot;btn btn-large btn-primary&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span>
       <span class="na">value=</span><span class="s">&quot;Sign in&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-in-sign-out.html#code-signin_form_html">リスト8.8</a>と<a class="ref" href="./sign-up.html#code-signup_form_html">リスト7.20</a>を比較することで、フォーム送信後に<code>params</code>ハッシュに入る値が、メールアドレスとパスワードのフィールドにそれぞれ対応した<code>params[:session][:email]</code>と<code>params[:session][:password]</code>になることを推測できることでしょう。</p>

<div class="label" id="sec-reviewing_form_submission"></div>


<h3><a id="sec-8_1_4" href="./sign-in-sign-out.html#sec-reviewing_form_submission" class="heading"><span class="number">8.1.4</span>確認フォームを送信する</a></h3>


<p>ユーザーを作成する (ユーザー登録) 場合と同様、セッションを作成する場合 (サインイン) で最初にやることは、<em>正しくない</em>入力の取り扱いです。ユーザー登録のテストは既に作成済みです (<a class="ref" href="./sign-in-sign-out.html#code-initial_failing_signin_test">リスト 8.5</a>)。そしてサインインのアプリケーションコードは、いくつかの点においてユーザー登録のコードとわずかに異なります。最初に、フォームが送信されたとき何が起こるかを考えましょう。次に、サインインが失敗した場合に表示されるエラーメッセージを配置します (モックアップを<a class="ref" href="./sign-in-sign-out.html#fig-signin_failure_mockup">図8.2</a>に示しました)。次に、サインインが送信されるたびに、パスワードとメールアドレスの組み合わせが正しいかどうかを判定し、サインインに成功した場合に使用する土台 (<a class="ref" href="./sign-in-sign-out.html#sec-signin_success">8.2</a>) を作成します。</p>

<p>最初に、Sessionsコントローラに最小限の<code>create</code>アクションを定義します (<a class="ref" href="./sign-in-sign-out.html#code-initial_create_session">リスト8.9</a>) 。このアクションは何も実行しませんが、<code>new</code>ビューを表示します。<a href="http://localhost:3000/sessions/new">/sessions/new</a>フォームを表示し、フィールドを空白のまま [Sign in] を押して送信すると<a class="ref" href="./sign-in-sign-out.html#fig-initial_failed_signin_rails_3">図8.5</a>のように表示されます。</p>

<div class="label" id="code-initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.9</span> <span class="description">Sessionsコントローラの<code>create</code>アクションの試作バージョン。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig-initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/initial_failed_signin_rails_3_bootstrap.png" alt="initial_failed_signin_rails_3_bootstrap" /></span></div><div class="caption"><span class="header">図8.5</span><span class="description"><a class="ref" href="./sign-in-sign-out.html#code-initial_create_session">リスト8.9</a>の<code>create</code>へのサインイン失敗結果。<a href="../images/figures/initial_failed_signin_rails_3_bootstrap-full.png">(拡大)</a></span></div></div>


<p><a class="ref" href="./sign-in-sign-out.html#fig-initial_failed_signin_rails_3">図8.5</a> に表示されているデバッグ情報に注目してください。<a class="ref" href="./sign-in-sign-out.html#sec-signin_form">8.1.3</a> の終わりにもヒントがありましたが、<code>params</code>ハッシュはメールアドレスとパスワードを以下のように<code>:session</code>キーの下に持ちます。</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&#39;&#39;</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Sign in</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>ユーザー登録の場合 (<a class="ref" href="./sign-up.html#fig-signup_failure">図7.15</a>) と同様、これらのパラメータは<a class="ref" href="./rails-flavored-ruby.html#code-nested_hashes">リスト4.6</a>に示したように<em>ネストした (入れ子になった) </em>ハッシュになっています。特に、<code>params</code>は以下のような入れ子ハッシュになっています。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">session:</span> <span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>これはつまり、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>上はそれ自体がハッシュであり、以下の要素を含んでいます。</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">password:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>その結果、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>上はフォームから送信されたメールアドレスであり、</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>上はフォームから送信されたパスワードです。</p>

<p>言い換えれば、<code>create</code>アクションの<code>params</code>ハッシュには、ユーザーの認証に必要な情報がすべて含まれているということになります。ここまでに、私たちはすでに必要なメソッドを手にしています。 Active Recordが<code>User.find_by_email</code>を提供し (<a class="ref" href="./modeling-users.html#sec-finding_user_objects">6.1.4</a>)、 <code>has_secure_password</code>が<code>authenticate</code>メソッドを提供しています (<a class="ref" href="./modeling-users.html#sec-user_authentication">6.3.3</a>)。認証に失敗したとき、<code>authenticate</code>の返り値は<code>false</code>になることを思い出してください。ユーザーのサインイン方法の方針をまとめると以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="c1"># ユーザーをサインインさせ、ユーザーページ (show) にリダイレクトする。</span>
  <span class="k">else</span>
    <span class="c1"># エラーメッセージを表示し、サインインフォームを再描画する。</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>最初の行は、送信されたメールアドレスを使用して、データベースからユーザーを取り出しています。(<a class="ref" href="./modeling-users.html#sec-uniqueness_validation">6.2.5</a>ではメールアドレスはすべて小文字で保存されていたことを思い出してください。従って、ここでは<code>downcase</code>メソッドを使用して、正しいメールアドレスが入力されたときに確実にマッチするようにしています)。次の行は少しわかりにくいかもしれませんが、Railsプログラミングでは定番の手法です。</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p><code>&amp;&amp;</code> (<em>論理積</em>) は、取得したユーザーが有効かどうかを決定するのに使用します。<code>nil</code>と<code>false</code>以外のすべてのオブジェクトは、真偽値では<code>true</code>になる (<a class="ref" href="./rails-flavored-ruby.html#sec-objects_and_message_passing">4.2.3</a>) というRubyの性質を考慮すると、 組み合わせは<a class="ref" href="./sign-in-sign-out.html#table-user_and_and">表8.2</a>のようになります。 <a class="ref" href="./sign-in-sign-out.html#table-user_and_and">表 8.2</a>を見ると、入力されたメールアドレスを持つユーザーがデータベースに存在し、かつ入力されたパスワードがそのユーザーのパスワードである場合のみ、<code>if</code>文が<code>true</code>になることがわかります。</p>

<div class="label" id="table-user_and_and"></div>


<div class="table"><div class="center">
<table class="tabular"><tr><th class="align_left"><strong>ユーザー</strong></th><th class="align_left"><strong>パスワード</strong></th><th class="align_left"><strong>a &amp;&amp; b</strong></th></tr><tr class="top_bar"><td class="align_left">存在しない</td><td class="align_left"><em>何でもよい</em></td><td class="align_left"><code>nil &amp;&amp; [anything] == false</code></td></tr><tr><td class="align_left">有効なユーザー</td><td class="align_left">誤ったパスワード</td><td class="align_left"><code>true &amp;&amp; false == false</code></td></tr><tr><td class="align_left">有効なユーザー</td><td class="align_left">正しいパスワード</td><td class="align_left"><code>true &amp;&amp; true == true</code></td></tr></table></div><div class="caption"><span class="header">表8.2</span><span class="description"><code>user &amp;&amp; user.authenticate(…)</code>の結果の組み合わせ。</span></div></div>




<div class="label" id="sec-rendering_with_a_flash_message"></div>


<h3><a id="sec-8_1_5" href="./sign-in-sign-out.html#sec-rendering_with_a_flash_message" class="heading"><span class="number">8.1.5</span>フラッシュメッセージを表示する</a></h3>


<p><a class="ref" href="./sign-up.html#sec-signup_error_messages">7.3.2</a>では、Userモデルのエラーメッセージを使用してユーザー登録のエラーメッセージを表示したことを思い出してください。これらのエラーメッセージは、特定のActive Recordオブジェクトに関連付けられていますが、セッションはActive Recordのモデルではないためにこの方法はここでは使用できません。代わりに、サインインに失敗したときにフラッシュメッセージを表示することにします。最初のコードを<a class="ref" href="./sign-in-sign-out.html#code-failed_signin_attempt">リスト8.10</a>に示します (ここには少しだけ間違いがあります)。</p>

<div class="label" id="code-failed_signin_attempt"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.10</span> <span class="description">サインインの失敗を扱う (誤りあり)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーをサインインさせ、ユーザーページ (show) にリダイレクトする。</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span> <span class="c1"># 誤りあり!</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>フラッシュメッセージはWebサイトのレイアウトに表示される (<a class="ref" href="./sign-up.html#code-layout_flash">リスト7.27</a>) ので、<code>flash[:error]</code>のメッセージは自動的に表示されます。Bootstrap CSSのおかげで適切なスタイルも与えられます (<a class="ref" href="./sign-in-sign-out.html#fig-failed_signin_flash">図8.6</a>)。</p>

<div class="label" id="fig-failed_signin_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/failed_signin_flash_bootstrap.png" alt="failed_signin_flash_bootstrap" /></span></div><div class="caption"><span class="header">図8.6</span><span class="description">サインインに失敗したときのフラッシュメッセージ。<a href="../images/figures/failed_signin_flash_bootstrap-full.png">(拡大)</a></span></div></div>


<p>残念ながら、本文および<a class="ref" href="./sign-in-sign-out.html#code-failed_signin_attempt">リスト8.10</a>のコメントで述べたように、このコードには誤りがあります。ページの表示には問題がないようですが、どこがおかしいのでしょうか。実は、ある<em>リクエスト</em>に対するフラッシュメッセージの内容がすぐに消えずに残ってしまうという問題があります。<a class="ref" href="./sign-up.html#code-signup_flash">リスト7.28</a>で使用したリダイレクトのときとは異なり、<code>render</code>で表示したテンプレートを再描画してもリクエストと見なされません。このため、フラッシュメッセージはひとつのリクエストに対して期待よりも長い間消えずに表示され続けてしまいます。たとえば、無効な情報を送信するとサインインページにフラッシュメッセージが設定されて表示されます (<a class="ref" href="./sign-in-sign-out.html#fig-failed_signin_flash">図8.6</a>)。ここでHomeページなどの別のページへのリンクをクリックすると、これはフォームが送信されてから最初のリクエストであるため、フラッシュメッセージが移動先のページでも表示されたままになってしまいます (<a class="ref" href="./sign-in-sign-out.html#fig-flash_persistence">図8.7</a>)。</p>

<div class="label" id="fig-flash_persistence"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/flash_persistence_bootstrap.png" alt="flash_persistence_bootstrap" /></span></div><div class="caption"><span class="header">図8.7</span><span class="description">フラッシュメッセージが消えずに残っている例。<a href="../images/figures/flash_persistence_bootstrap-full.png">(拡大)</a></span></div></div>


<p>フラッシュメッセージの残留問題はこのアプリケーションのバグです。この問題を修正する前に、この問題をキャッチするテストを書くのが正しいやり方です。特に、現在のサインイン失敗テストではこの問題がキャッチされずにパスしてしまいます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>当然ながら、既知のバグが未修正の状態であれば、このテストはパスするべきではありません。この問題をキャッチする、失敗するテストを追加しましょう。幸い、結合テストはフラッシュメッセージ残留などの多くの問題解決において大活躍します。期待される動作は以下のテストで正確に表現されています。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>このテストは、無効なサインインデータを送信し、次にWebサイトのレイアウトにあるHomeリンクを開き、フラッシュメッセージが表示されていないことを確認します。フラッシュテストの部分を更新したテストコードを<a class="ref" href="./sign-in-sign-out.html#code-correct_signin_failure_test">リスト8.11</a>に示します。</p>

<div class="label" id="code-correct_signin_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.11</span> <span class="description">サインインの失敗を正しくテストするコード。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>

    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">describe</span> <span class="s2">&quot;after visiting another page&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Home&quot;</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>再度テストを実行すると、期待どおり失敗します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;signin with invalid information&quot;</span>
</pre></div>
</div>


<p>失敗するテストがパスするようになるために、<code>flash</code>の代わりに<code>flash.now</code>を使用します。これもページでフラッシュメッセージを表示するために特に設計されたメソッドですが、<code>flash</code>の場合とは異なり、他のリクエストが発生したらすぐにメッセージを消します。正しいアプリケーションコードを<a class="ref" href="./sign-in-sign-out.html#code-correct_signin_failure">リスト8.12</a>に示します。</p>

<div class="label" id="code-correct_signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.12</span> <span class="description">サインインが失敗したときの正しいコード。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="c1"># ユーザーをサインインさせ、ユーザーページ (show) にリダイレクトする。</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これで、ユーザー情報が無効な場合のテストスイートが緑色 (成功) になりました。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/requests/authentication_pages_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;with invalid information&quot;</span>
</pre></div>
</div>




<div class="label" id="sec-signin_success"></div>


<h2><a id="sec-8_2" href="./sign-in-sign-out.html#sec-signin_success" class="heading"><span class="number">8.2</span>サインイン成功</a></h2>


<p> サインイン失敗をテストできるようにしたので、次は実際にユーザーをサインインさせましょう。この節で必要なRubyのプログラミングは、本書の中ではこれまでで最も難易度が高くなっています。どうか最後まであきらめずにがんばってください。ここからの力仕事に備えておきましょう。幸い、はじめの一歩は簡単です。Sessionsコントローラの<code>create</code>アクションはすぐできあがります。残念ながら、少々ズルもしています。</p>

<p>サインインの実装 (<a class="ref" href="./sign-in-sign-out.html#code-correct_signin_failure">リスト8.12</a>) はシンプルです。サインインに成功すると、<code>sign_in</code>関数を使用して実際にユーザーをサインインさせ、プロファイルページにリダイレクトします (<a class="ref" href="./sign-in-sign-out.html#code-sign_in_success_not_yet_working">リスト8.13</a>)。なぜこれがズルなのかというと、何と<code>sign_in</code>はこの時点では存在していないのです。この節の残りは、この関数を完成させることに費やされます。</p>

<div class="label" id="code-sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.13</span> <span class="description">Sessionsコントローラの<code>create</code>アクションが完成したところ (まだ動きません)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">].</span><span class="n">downcase</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">else</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid email/password combination&#39;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-remember_me"></div>


<h3><a id="sec-8_2_1" href="./sign-in-sign-out.html#sec-remember_me" class="heading"><span class="number">8.2.1</span>[このアカウント設定を保存する]</a></h3>


<p>これよりサインインモデルの実装を開始します。具体的には、サインイン状態を「永続化」し、ユーザーが明示的にサインアウトしたときにのみセッションを終了します。サインイン関数そのものは伝統的なMVC (model-view-controller)) に帰着します。特に、いくつかのサインイン関数についてはコントローラとビューのどちらからも使用できるようにする必要があります。<a class="ref" href="./rails-flavored-ruby.html#sec-back_to_the_title_helper">4.2.5</a>を思い出してみてください。Rubyには、いくつもの関数をパッケージ化し、さまざまな場所でインクルードできるようにする<em>モジュール</em>という機能が提供されています。これを認証機能の実装に使用しましょう。認証のためにまったく新しいモジュールを作ることも可能ですが、Sessionsコントローラには既に<code>SessionsHelper</code>というモジュールが備わっています。さらに、ヘルパーはRailsのビューに自動的にインクルードされるので、Applicationコントローラにこのモジュールをインクルードするだけで、Sessionsヘルパー機能をコントローラ内で使用できるようになります (<a class="ref" href="./sign-in-sign-out.html#code-sessions_helper_include">リスト8.14</a>)。</p>

<div class="label" id="code-sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.14</span> <span class="description">SessionsヘルパーモジュールをApplicationコントローラにインクルードする。</span><br /><span class="description"> <code>app/controllers/application_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="ss">ActionController::Base</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with:</span> <span class="ss">:exception</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>デフォルトでは、すべてのヘルパーはビューで使用できますが、コントローラでは使用可能になっていません。Sessionsヘルパーはビューとコントローラの両方でメソッドが必要となるので、コントローラでは上のように明示的にインクルードする必要があります。</p>

<p>HTTPは<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>ステートレスなプロトコル</em></a>であり、そのままでは状態が保存されないので、Webアプリケーションのサインインは、ページからページの移動を追跡するという方法で実装する必要があります。ユーザーのサインイン状態を保持するひとつの方法は、伝統的なRailsセッション (特殊な<code>session</code>関数を使用) を使って、ユーザーIDに等しい「<em>記憶トークン (remember token)</em>」を保持することです。</p>

<div class="code"><div class="highlight"><pre><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>この<code>session</code>オブジェクトは、ユーザーidをcookiesに保持することで、ページ移動後にもユーザーidを参照できるようにしています。cookiesはブラウザが閉じられると無効になります。アプリケーションは、ページごとに以下の呼び出しを行います。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>これだけで、ユーザーを取り出すことができます。Railsでは、セッションがセキュアになるように扱っていますので、悪意のあるユーザーがidをなりすまそうとしても、Railsはセッションごとに生成される特別の<em>セッションid</em>によって不一致を検出します。</p>

<p>私たちのアプリケーション設計では、<em>永続的な</em>セッションを採用します。つまり、ブラウザを閉じた後にもサインイン状態を保持するということであり、サインインしたユーザーに対して何らかの<em>恒久的な</em>識別子を使用する必要があります。これを実現するために、ユーザーごとに一意かつ安全な記憶トークンを生成し、ブラウザを閉じても無効にならない<em>恒久的な</em>cookiesとして登録します。</p>

<p>記憶トークンはユーザーに関連付けられる必要があります。また、今後使用するときのために保持しておく必要もあります。そこで、<a class="ref" href="./sign-in-sign-out.html#fig-user_model_remember_token">図8.8</a>に示すUserモデルの属性に記憶トークンの保存場所を追加しましょう。</p>

<div class="label" id="fig-user_model_remember_token"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/user_model_remember_token_31.png" alt="user_model_remember_token_31" /></span></div><div class="caption"><span class="header">図8.8</span><span class="description"><code>remember_token</code>属性を追加したUserモデル。</span></div></div>


<p>最初に、Userモデルのspecに若干の追加を行います (<a class="ref" href="./sign-in-sign-out.html#code-user_responds_to_remember_token">リスト8.15</a>)。</p>

<div class="label" id="code-user_responds_to_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.15</span> <span class="description">記憶トークン用の最初のテスト。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:password_confirmation</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:authenticate</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>コマンドラインで以下のように記憶トークンを生成することで、上のテストがパスするようになります。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_remember_token_to_users
</pre></div>
</div>


<p>次に、上で生成されたマイグレーションに<a class="ref" href="./sign-in-sign-out.html#code-add_remember_token_to_users">リスト8.16</a>のコードを記入します。ユーザーを記憶トークンで検索できるように、インデックス (<a class="ref" href="./modeling-users.html#sidebar-database_indices">コラム 6.2</a>) を<code>remember_token</code>カラムに追加していることに注目してください。</p>

<div class="label" id="code-add_remember_token_to_users"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.16</span> <span class="description"><code>remember_token</code>を<code>users</code>テーブルに追加したマイグレーション。</span><br /><span class="description"> <code>db/migrate/[ts]_add_remember_token_to_users.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddRememberTokenToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Migration</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">add_index</span>  <span class="ss">:users</span><span class="p">,</span> <span class="ss">:remember_token</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>次に、いつものように開発データベースとテストデータベースを更新します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake db:migrate
<span class="gp">$</span> bundle <span class="nb">exec </span>rake <span class="nb">test</span>:prepare
</pre></div>
</div>


<p>この時点で、Userモデルのspecはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<p>ここで、記憶トークンに何を使用するかを決める必要があります。有力な候補としてさまざまなものが考えられますが、基本的には一意性を確保できる、長くてランダムな文字列でさえあればどんなものでも良いでしょう。Ruby標準ライブラリの<code>SecureRandom</code>モジュールにある<code>urlsafe_base64</code>メソッドならこの用途にぴったりです<sup class="footnote" id="fnref-8_3"><a href="./sign-in-sign-out.html#fn-8_3">3</a></sup>。このメソッドは、A–Z、a–z、0–9、“-”、“_”のいずれかの文字 (64種類) からなる長さ16のランダムな文字列を返します (そのため<a href="http://en.wikipedia.org/wiki/Base64">base64</a>と呼ばれています)。生成された2つの記憶トークンが偶然一致 (衝突) する確率は、64のマイナス16乗、2のマイナス96乗 (10のマイナス29乗) にほぼ等しく、トークンが衝突することはまずありません。</p>

<p>ここでのねらいは、ブラウザにこのbase64トークンを保存しておき、データベースにはトークンを暗号化したものを保存することです。そして、cookiesからこのトークンを読みだして暗号化し、データベース上にある暗号化された記憶トークンと一致するものがあるかどうかを検索することにより、ユーザーを自動的にサインインさせることができます。暗号化したトークンだけをデータベースに保存する理由は、万が一データベースが不正アクセスを受けるようなことがあっても、攻撃者が記憶トークンを使用してサインインできないようにするためです。記憶トークンをさらにセキュアにするためには、新しいセッションを作成するたびにトークンを更新するのがよい方法です。この方法なら、攻撃者が盗んだcookiesを使用して本物のユーザーになりすましてサインインしようとする (<a href="http://en.wikipedia.org/wiki/Session_hijacking">セッションハイジャック</a>) ことがあっても、ユーザーが次回サインインするときにはトークンが期限切れになります。(セッションハイジャックは、セキュリティ上の注意を呼びかけるためにこれを実演する<a href="http://codebutler.com/firesheep">Firesheep</a>アプリケーションによって広く知られるようになりました。Firesheepを使用すると、公共Wi-Fiネットワーク経由で接続したときに多くの有名Webサイトの記憶トークンが丸見えになっていることがわかります。この問題を解決するには、<a class="ref" href="./sign-up.html#sec-deploying_to_production_with_ssl">7.4.4</a>で説明したようにWebサイト全体をSSLで暗号化することです。)</p>

<p>サンプルアプリケーションでは、新規作成されたユーザーをその場でサインインさせ、その副作用として記憶トークンがついでに作成されますが、この動作に依存すべきではありません。安全を確保するために、<em>すべての</em>ユーザーが必ず最初から有効な記憶トークンを持つようにする必要があります。これを確実に行うには、<em>コールバック</em>を使用して記憶トークンを生成します。このテクニックは、<a class="ref" href="./modeling-users.html#sec-uniqueness_validation">6.2.5</a>でemailの一意性の文脈で紹介しました。あのときは<code>before_save</code>というコールバックを使用しましたが、ここではそれによく似た<code>before_create</code>というコールバックを使用して、ユーザー新規作成時に記憶トークンを設定することにします<sup class="footnote" id="fnref-8_4"><a href="./sign-in-sign-out.html#fn-8_4">4</a></sup>。</p>

<p>記憶トークンをテストするために、最初にテストユーザーを保存し (これまでは作成されても保存はされていませんでした)、次にユーザーの<code>remember_token</code>属性が空欄でないことを確認します。これにより、必要が生じたときにランダム文字列を変更するのに十分な柔軟性が得られます。このテストを<a class="ref" href="./sign-in-sign-out.html#code-remember_token_should_not_be_blank">リスト8.17</a>に示します。</p>

<div class="label" id="code-remember_token_should_not_be_blank"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.17</span> <span class="description">記憶トークンが有効である (空欄のない) ことをテストする。</span><br /><span class="description"> <code>spec/models/user_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                     <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;remember token&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span> <span class="p">}</span>
    <span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上の<a class="ref" href="./sign-in-sign-out.html#code-remember_token_should_not_be_blank">リスト8.17</a>で導入した<code>its</code>メソッドは、<code>it</code>と似ていますが、itが指すテストのsubject (ここでは@user) そのものではなく、引数として与えられたその属性 (この場合は:remember_token) に対してテストを行うときに使用します。</p>

<div class="code"><div class="highlight"><pre><span class="n">its</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>つまり、上のコードは以下と等価です。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">remember_token</span><span class="p">)</span><span class="o">.</span><span class="n">not_to</span> <span class="n">be_blank</span> <span class="p">}</span>
</pre></div>
</div>


<p>このアプリケーションコードでは、新しい要素をいくつか導入します。最初に、記憶トークンを作成するために以下のようにコールバックメソッドを追加します。</p>

<div class="code"><div class="highlight"><pre><span class="n">before_create</span> <span class="ss">:create_remember_token</span>
</pre></div>
</div>


<p>上のコードは<em>メソッド参照</em>と呼ばれるもので、こうすることでRailsは<code>create_remember_token</code>というメソッドを探し、ユーザーを保存する前に実行するようになります (<a class="ref" href="./modeling-users.html#code-email_downcase">リスト6.20</a>では、<code>before_save</code>に明示的にブロックを渡していましたが、メソッド参照の方が一般にお勧めできます) 。次に、このメソッド自身はUserモデルの内部でしか使用しないので、外部のユーザーがアクセスできるようにする必要はありません。<a class="ref" href="./sign-up.html#sec-strong_parameters">7.3.2</a>でも触れたように、メソッド定義に以下のように<code>private</code>キーワードを与えるのがRuby流です。</p>

<div class="code"><div class="highlight"><pre><span class="kp">private</span>

  <span class="k">def</span> <span class="nf">create_remember_token</span>
    <span class="c1"># トークンを作成する。</span>
  <span class="k">end</span>
</pre></div>
</div>


<p><code>private</code>キーワード以降で定義されたメソッドはすべて隠蔽されます。</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">create_remember_token</span>
</pre></div>
</div>


<p>このため、上をコンソールで実行すると<code>NoMethodError</code>例外が発生します。</p>

<p>最後に、<code>create_remember_token</code>メソッドは、ユーザーの属性のひとつに「<em>要素代入 (assignment)</em>」する必要があります。この文脈では、<code>remember_token</code>の前に<code>self</code>キーワードを追加する必要があります。</p>

<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="ss">Digest::SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">)</span>
    <span class="k">end</span>
</pre></div>
</div>


<p>上のコードに<code>self</code>というキーワードがないと、要素代入によって<code>remember_token</code>という名前の<em>ローカル</em>変数が作成されてしまうので、注意が必要です (ここで本来必要なのはローカル変数ではなく、インスタンス変数です)。この動作は、Rubyにおけるオブジェクト内部への要素代入の仕様によるものです。<code>self</code>キーワードを与えることで、要素代入は正しくそのユーザーの<code>remember_token</code>属性を設定するようになり、その結果ユーザーが保存されるときに他の属性と一緒にこの属性もデータベースに保存されます (<a class="ref" href="./modeling-users.html#code-email_downcase">リスト6.20</a>の他の<code>before_save</code>コールバックでも、<code>email</code>ではなく<code>self.email</code>と記述していた理由が、これでおわかりいただけたと思います)。</p>

<p><a href="https://en.wikipedia.org/wiki/SHA-1">SHA1</a>を使用して記憶トークンを暗号化すると、<a class="ref" href="./modeling-users.html#sec-an_encrypted_password">6.3.1</a>でユーザーのパスワード暗号化に使用していたBcryptアルゴリズムよりも動作がはるかに高速である点に注目してください。<a class="ref" href="./sign-in-sign-out.html#sec-a_working_sign_in_method">8.2.2</a>でも説明しますが、トークンの暗号化はユーザーがページを開くたびに行うので、暗号化アルゴリズムが高速であることは重要です。SHA1はBcryptと比べるとそれほどセキュアではありませんが、元となるトークンが既に16桁のランダムな文字列なので、これで十分です。このようなランダムな文字列をさらにSHA1でhexdigestしたものは、本質的にクラック不可能です (<em>to_s</em>メソッドを呼び出しているのは、<code>nil</code>トークンを扱えるようにするためです。ブラウザでnilトークンが発生することはあってはなりませんが、テスト中に発生することはありえるためです)。</p>

<p><code>encrypt</code>メソッドと<code>new_remember_token</code>メソッドは、ユーザーのインスタンスに対して動作する必要がないので、インスタンスではなく<code>User</code>クラスに属します (クラスメソッド)。また、これらのメソッドは<code>private</code>行より上にあるのでpublicになっていますが、これは<a class="ref" href="./sign-in-sign-out.html#sec-current_user">8.2.3</a>でUserモデルの外で使用する必要があるためです。</p>

<p>以上の実装をまとめたUserモデルを<a class="ref" href="./sign-in-sign-out.html#code-before_create_remember_token">リスト8.18</a>に示します。</p>

<div class="label" id="code-before_create_remember_token"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.18</span> <span class="description"><code>before_create</code>コールバックを使用して <code>remember_token</code>属性を作成する。</span><br /><span class="description"> <code>app/models/user.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord::Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">downcase</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="ss">:create_remember_token</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">new_remember_token</span>
    <span class="no">SecureRandom</span><span class="o">.</span><span class="n">urlsafe_base64</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="ss">Digest::SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">create_remember_token</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ちなみに、<code>private</code>キーワード以降のコードは、強調のため<code>create_remember_token</code>のインデントを1段深くしてあります (経験上、こうしておくことをお勧めします)。</p>

<p><code>SecureRandom.urlsafe_base64</code>は決して空欄には<em>ならなくなった</em>ので、Userモデルのテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/models/user_spec.rb
</pre></div>
</div>


<div class="label" id="sec-a_working_sign_in_method"></div>


<h3><a id="sec-8_2_2" href="./sign-in-sign-out.html#sec-a_working_sign_in_method" class="heading"><span class="number">8.2.2</span>正しい<tt>sign_in</tt>メソッド</a></h3>


<p>いよいよ、最初のサインイン要素である<code>sign_in</code>関数自身の実装に取りかかりましょう。既に述べたように、これから作る認証メソッドは、記憶トークンをブラウザのcookiesに保存し、ユーザーが別のページに移動する (<a class="ref" href="./sign-in-sign-out.html#sec-current_user">8.2.3</a>で実装予定) ときにそのトークンを使用してデータベース内のユーザーのレコードを見つけます。このコードを<a class="ref" href="./sign-in-sign-out.html#code-sign_in_function">リスト8.19</a>に示します。なお、このコードには<code>current_user</code>というメソッドがありますが、これは<a class="ref" href="./sign-in-sign-out.html#sec-current_user">8.2.3</a>で実装します。</p>

<div class="label" id="code-sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.19</span> <span class="description">完全だがまだ動作しない<code>sign_in</code>関数。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>ここでは以下の手順で進めます。1) トークンを新規作成する。2) 暗号化されていないトークンをブラウザのcookiesに保存する。3) 暗号化したトークンをデータベースに保存する。4) 与えられたユーザーを現在のユーザーに設定する (<a class="ref" href="./sign-in-sign-out.html#sec-current_user">8.2.3</a>)。上のコードで、<code>update_attribute</code>を使用してトークンを保存している点に注目してください。<a class="ref" href="./modeling-users.html#sec-updating_user_objects">6.1.5</a>でも簡単に説明しましたが、このメソッドを使用すれば検証をバイパスして単一の属性を更新することができます。ページの移動ではユーザーのパスワードやパスワード確認は与えられないので、このメソッドを使用する必要があります。</p>

<p><a class="ref" href="./sign-in-sign-out.html#code-sign_in_function">リスト8.19</a>ではRailsが提供する<code>cookies</code>ユーティリティも使用しています。これを使用することで、ブラウザのcookiesをハッシュのように扱うことができます。cookiesの各要素は、それ自体が2つの要素 (<code>value</code>とオプションの<code>expires</code>日時) のハッシュになっています。たとえば以下のように、cookiesに20年後に期限切れになる記憶トークンに等しい値を保存することで、ユーザーのサインインを実装できます。</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">value:</span>   <span class="n">remember_token</span><span class="p">,</span>
                             <span class="ss">expires:</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(上のコードではRailsの便利なtimeヘルパーを使用しています。<a class="ref" href="./sign-in-sign-out.html#sidebar-time_helpers">コラム 8.1</a>を参照してください。)</p>

<div class="label" id="sidebar-time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 8.1</span><span class="description">cookiesは今から20年後に切れる (<tt>20.years.from_now</tt>)</span></span>
<p>Rubyは組み込みクラスを含む<a class="ref" href="./rails-flavored-ruby.html#sec-a_class_of_our_own">あらゆる</a>クラスにメソッドを追加できることを<em>4.4.2</em>で学びました。あのときは、<tt>palindrome?</tt>メソッドを<tt>String</tt>クラスに追加しました (ついでに<tt>&quot;deified&quot;</tt>も回文になっていることを発見しました)。また、Railsが実は<tt>blank?</tt>メソッドを<tt>Object</tt>クラスに追加していることも判明しました (これにより、<tt>&quot;&quot;.blank?</tt>、<tt>&quot; &quot;.blank?</tt>、<tt>nil.blank?</tt>はいずれも<tt>true</tt>になります)。<a class="ref" href="./sign-in-sign-out.html#code-sign_in_function">リスト8.19</a>のコードでは、cookiesが20年後に期限切れになる (<tt>20.years.from_now</tt>) ように指定していますが、これはRailsの<em>timeヘルパー</em>を使用した格好の例題になります。timeヘルパーはRailsによって、数値関連の基底クラスである<tt>Fixnum</tt>クラスに追加されます。</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Railsは以下のようなヘルパーも追加しています。</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>上のヘルパーは、ファイルのアップロードに<tt>5.megabytes</tt>などの制限を与えるのに便利です。</p>

<p>メソッドを組み込みクラスに追加できる柔軟性の高さのおかげで、純粋なRubyを極めて自然に拡張することができます (もちろん注意して使う必要はありますが)。実際、Railsのエレガントな仕様の多くは、背後にあるRubyの高い拡張性によって実現されているのです。</p>
</div>


<p>上のように20年で期限切れになるcookies設定はよく使われるようになり、今ではRailsにも特殊な<code>permanent</code>という専用のメソッドが追加されたほどです。このメソッドを使用すると、コードは以下のようにシンプルになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
</pre></div>
</div>


<p>上のコードでは、<code>permanent</code>メソッドによって自動的に期限が<code>20.years.from_now</code>に設定されます。</p>

<p>cookiesを設定後、移動先のページで以下のようなコードを使用してユーザーを取り出すことができます。</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token:</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div>
</div>


<p>もちろん、この<code>cookies</code>は<em>本物の</em>ハッシュではなく、実際には<code>cookies</code>に割り当てを行ったときにブラウザ上のテキストの断片を<em>保存</em>しているだけです。そうしたアプリケーションの実装の詳細を気にしなくてよい点に、Railsの美しさの一端が垣間見えます。</p>

<div class="label" id="sec-current_user"></div>


<h3><a id="sec-8_2_3" href="./sign-in-sign-out.html#sec-current_user" class="heading"><span class="number">8.2.3</span>現在のユーザー</a></h3>


<p>後で使うために記憶トークンをcookiesに保存する方法の説明が終わりましたので、今度は移動先のページでユーザーを取り出す方法について学びましょう。<code>sign_in</code>関数のコードをもういちどよく見てみてください。</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>現時点では、上のコードのうち、以下のコードだけが動作していません。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>この行の目的は、コントローラからもビューからもアクセスできる<code>current_user</code>を作成することです。これにより、以下のような構文を使用できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>以下も使用できるようになります。</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p><a class="ref" href="./sign-in-sign-out.html#code-before_create_remember_token">リスト8.18</a>のときに説明したのと同じ理由で、ここにも<code>self</code>が必要です。<code>self</code>がないと、Rubyは単に<code>current_user</code>というローカル変数を作成してしまいます。</p>

<p><code>current_user</code>のコードを書く上で、以下の行については注意が必要です。</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>上は「<em>要素代入 (assignment)</em>」であることに注意してください。このcurrent_user=は別途定義が必要です。<a class="ref" href="./sign-in-sign-out.html#code-current_user_equals">リスト8.20</a>に示したように、Rubyにはこのような要素代入関数を定義する特殊な文法があります。</p>

<div class="label" id="code-current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.20</span> <span class="description"><code>current_user</code>への要素代入を定義する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードで使用されている特殊な文法は混乱しやすいので注意してください。普通のプログラミング言語では、定義するメソッドの名前に等号を使用することはできませんが、Rubyではメソッド名末尾の等号には特殊な意味があり、上のコードは<code>current_user</code>への要素代入を扱うように設計された<code>current_user=</code>というメソッドを単に定義します。つまり、以下のコードは</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</pre></div>
</div>


<p>自動的に以下のコードに置き換えられます。</p>

<div class="code"><div class="highlight"><pre><span class="n">current_user</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>そして最終的に<code>current_user=</code>というメソッドが呼び出されます。その引数は要素代入の右側にひとつ置かれます (ここではサインインするユーザー)。この一行メソッドは、単に<code>@current_user</code>インスタンス変数を設定し、後に使用するためにユーザーを効率よく保存します。</p>

<p>通常のRubyでは、もうひとつのメソッドとして<code>current_user</code>を定義することができます。<a class="ref" href="./sign-in-sign-out.html#code-current_user_wrong">リスト8.21</a>に示したように、このメソッドは<code>@current_user</code>の値を返すようになっています。</p>

<div class="label" id="code-current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.21</span> <span class="description">つい使ってみたくなるが実際には役に立たない<code>current_user</code>の定義</span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># 役に立たない。</span><span class="c1">この行は使用しないこと。</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>もしかすると、これを使用して<a class="ref" href="./rails-flavored-ruby.html#sec-a_user_class">4.4.5</a>の<code>attr_accessor</code>を効率よく置き換えることができるのではないでしょうか<sup class="footnote" id="fnref-8_5"><a href="./sign-in-sign-out.html#fn-8_5">5</a></sup>。それをしないのは、このコードを使用すると今までの苦労が台無しになってしまうからです。<a class="ref" href="./sign-in-sign-out.html#code-current_user_wrong">リスト8.21</a>のコードを使用すると、ユーザーが別のページに移動した瞬間にユーザーのサインイン情報が<em>きれいさっぱり</em>消滅してしまいます。セッションは終了し、ユーザーは自動的にサインアウトしてしまいます。この問題を回避するには、<a class="ref" href="./sign-in-sign-out.html#code-current_user_working">リスト8.22</a>に示したように、<a class="ref" href="./sign-in-sign-out.html#code-sign_in_function">リスト8.19</a>のコードで作成した記憶トークンに対応するユーザーを検索します。データベース上の記憶トークンは暗号化されているので、cookiesから取り出した記憶トークンは、データベース上の記憶トークンを検索する前に暗号化する必要がある点に注意してください。これを行うには、<a class="ref" href="./sign-in-sign-out.html#code-before_create_remember_token">リスト8.18</a>で定義した<code>User.encrypt</code>を使用します。</p>

<div class="label" id="code-current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.22</span> <span class="description"><code>remember_token</code>を使用して現在のユーザーを検索する。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token:</span> <span class="n">remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-in-sign-out.html#code-current_user_working">リスト8.22</a>では、Rubyでは定番の (しかし最初はまごつきやすい) <code>||=</code> (“or equals”) 代入演算子を使用しています (<a class="ref" href="./sign-in-sign-out.html#sidebar-or_equals">コラム 8.2</a>)。この代入演算子は、<code>@current_user</code>が未定義の場合にのみ、<code>@current_user</code>インスタンス変数に記憶トークンを設定します<sup class="footnote" id="fnref-8_6"><a href="./sign-in-sign-out.html#fn-8_6">6</a></sup>。</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">remember_token:</span> <span class="n">remember_token</span><span class="p">)</span>
</pre></div>
</div>


<p>あるユーザーに対して<code>current_user</code>が初めて呼び出される場合は<code>find_by</code>メソッドを呼び出しますが、以後の呼び出しではデータベースにアクセスせずに<code>@current_user</code>を返します<sup class="footnote" id="fnref-8_7"><a href="./sign-in-sign-out.html#fn-8_7">7</a></sup>。このコードは、ひとつのユーザーリクエストに対して<code>current_user</code>が何度も使用される場合にのみ有用です。いずれの場合も、ユーザーがWebサイトにアクセスすると<code>find_by</code>は最低1回は呼び出されます。</p>

<div class="label" id="sidebar-or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">コラム 8.2</span><span class="description"></span><span class="description"><tt>||=</tt>とは何か</span></span>
<p><tt>||=</tt>という記法は非常にRuby的であり、Rubyという言語を強く特徴づけるものです。Rubyプログラミングの達人になりたいのであれば、この記法を習得することが重要です。<em>or equals</em>という概念は一見神妙不可思議に見えますが、他のものになぞらえて考えることで理解できます。</p>

<p>最初は、現在定義されている変数を変更するというありふれたコードについて説明します。多くのコンピュータプログラムでは、以下のようにして変数の値を1つ増やすことができます。</p>

<pre class="verbatim">  x = x + 1</pre>


<p>そして、Ruby (C、C++、Perl、Python、Java) などの多くのプログラミング言語では、以下のような短縮形を使用して上の演算を行うことができます。</p>

<pre class="verbatim">  x += 1</pre>


<p>他の演算子についても同様の短縮形が利用できます。</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>いずれの場合も、<tt>●</tt>という演算子があるときの「<tt>x = x ● y</tt>」と「<tt>x ●= y</tt>」の動作は同じです。</p>

<p>Rubyでは、「変数の値が<tt>nil</tt>なら変数に代入するが、nilでなければ代入しない (変数の値を変えない)」という操作が非常によく使われます。<em>4.2.3</em>で説明した<tt>or</tt>演算子<a class="ref" href="./rails-flavored-ruby.html#sec-objects_and_message_passing">||</a>を使用すれば、以下のように書くことができます。</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || &quot;the user&quot;
  =&gt; &quot;the user&quot;
  &gt;&gt; @user = @user || &quot;another user&quot;
  =&gt; &quot;the user&quot;</pre>


<p><tt>nil</tt>の論理値は偽 (false) です。初めて代入するときは「<tt>nil || &quot;the user&quot;</tt>」となり、これは「<tt>&quot;the user&quot;</tt>」と評価されます。同様に、2度目の代入では「<tt>&quot;the user&quot; || &quot;another user&quot;</tt>」となり、これも「<tt>&quot;the user&quot;</tt>」と評価されます。あらゆる文字列の論理値は真 (<tt>true</tt>) なので、 <tt>||</tt>を使用する一連の式は、いずれも1番目の式が評価された時点で終了します (なお、<tt>||</tt>式を左から右に評価し、最初の左の値がtrueであればその時点で終了するというやり方を<em>短絡評価 (short-circuit evaluation)</em>と呼びます)。</p>

<p>上述した多くの演算子をコンソールセッション上で実行して比較してみると、<tt>@user = @user || value</tt>は「<tt>x = x O y</tt>」のパターンに該当し、<tt>O</tt>が<tt>||</tt>に置き換わっただけのものであることがわかります。ということは、この演算は以下と同じであることが推測できます。</p>

<pre class="verbatim">  &gt;&gt; @user ||= &quot;the user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>お試しあれ。</p>
</div>




<div class="label" id="sec-changing_the_layout_links"></div>


<h3><a id="sec-8_2_4" href="./sign-in-sign-out.html#sec-changing_the_layout_links" class="heading"><span class="number">8.2.4</span>レイアウトリンクを変更する</a></h3>


<p>サインイン/サインアウトが動作するようになり、実用的なアプリケーションらしくなってきました。今度は、サインインの状態に合わせてレイアウト上のリンクが変わるようにしましょう。特に、<a class="ref" href="./sign-in-sign-out.html#fig-signin_success_mockup">図8.3</a>のモックアップで示したように、ユーザーがサインインしているときとサインアウトしているときでリンクを変更し、すべてのユーザーを表示するリンクとユーザー設定用のリンクも追加し (<a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>で完成する予定)、さらに現在のユーザーのプロファイルのリンクも追加します。これらを実装することで、<a class="ref" href="./sign-in-sign-out.html#code-signin_success_tests">リスト8.6</a>のテストがパスするようになります。つまり、本章開始以来初めてテストスイート全体が緑色 (成功) になるということです。</p>

<p>サイトレイアウトのリンクを変更するには、埋め込みRubyの内側でif-else分岐構造を使用します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  # サインインしているユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  #サインインしていないユーザー用のリンク
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>この種のコードでは、<code>signed_in?</code> 論理値が必要になりますので、これから定義しましょう。</p>

<p>ユーザーがサインインしている状態は、セッションに現在のユーザーがいる (<code>current_user</code>が<code>nil</code>でない) ことで表されます。これを表現するには否定の演算子が必要なので、<code>!</code> (&quot;bang&quot; と読みます) を使用します。<a class="ref" href="./sign-in-sign-out.html#code-signed_in_p">リスト8.23</a>に示すとおり、現在の文脈では<code>current_user</code>が<code>nil</code>で<em>ない</em>場合にユーザーがサインインしています。</p>

<div class="label" id="code-signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.23</span> <code>signed_in?</code><span class="description">ヘルパーメソッド。</span><span class="description"></span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><code>signed_in?</code>メソッドを手作りしてあるので、レイアウトのリンクはすぐに作成できます。なお、新しく作るリンクは4つですが、そのうち以下の2つのリンクは未実装です (<a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>で完成の予定)。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>サインアウトのリンクには、<a class="ref" href="./sign-in-sign-out.html#code-sessions_resource">リスト8.2</a>で定義したサインアウトのパスを使用します。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>(上のコードでは、サインアウトのリンクがハッシュ引数を渡していることに注目してください。このハッシュ引数は、HTTPの<tt>DELETE</tt>リクエストを使用して送信される必要があることを示しています<sup class="footnote" id="fnref-8_8"><a href="./sign-in-sign-out.html#fn-8_8">8</a></sup>)。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>なお、上のコードは以下のように書くこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Railsでは、このユーザーへの直接リンクが許されるので、この場合<code>current_user</code>は<code>user_path(current_user)</code>に自動的に変換されます。</p>

<p>新しいリンクをレイアウトに追加するときに、Bootstrapの機能を使用してドロップダウンメニューを実現しましょう。詳細については「<a href="http://twitter.github.com/bootstrap/components.html">Bootstrapコンポーネント</a> (英語)」を参照してください。完全なコードを<a class="ref" href="./sign-in-sign-out.html#code-layout_signin_signout_links">リスト8.24</a>に示します。このコードでは、Bootstrapのドロップダウンメニューに関連するCSSのidとクラスが与えられていることに注目してください。</p>

<div class="label" id="code-layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.24</span> <span class="description">サインインしているユーザー用にリンクを変更する。</span><br /><span class="description"> <code>app/views/layouts/_header.html.erb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-fixed-top navbar-inverse&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-inner&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;sample app&quot;</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;logo&quot;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;nav&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav pull-right&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">id=</span><span class="s">&quot;fat-menu&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;dropdown-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;dropdown&quot;</span><span class="nt">&gt;</span>
                Account <span class="nt">&lt;b</span> <span class="na">class=</span><span class="s">&quot;caret&quot;</span><span class="nt">&gt;&lt;/b&gt;</span>
              <span class="nt">&lt;/a&gt;</span>
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;dropdown-menu&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;divider&quot;</span><span class="nt">&gt;&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="nb">method</span><span class="p">:</span> <span class="s2">&quot;delete&quot;</span> <span class="cp">%&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
              <span class="nt">&lt;/ul&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
            <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
          <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>ドロップダウンメニューを実現するには、BootstrapのJavaScriptライブラリが必要です。このライブラリは、RailsのAsset Pipelineを使用してインクルードすることができます。そのためには、<a class="ref" href="./sign-in-sign-out.html#code-bootstrap_js">リスト8.25</a>に示すようにアプリケーションのJavaScriptファイルを編集します。</p>

<div class="label" id="code-bootstrap_js"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.25</span> <span class="description">Bootstrap JavaScriptライブラリを<code>application.js</code>に追加する。</span><br /><span class="description"> <code>app/assets/javascripts/application.js</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="c1">//= require jquery</span>
<span class="c1">//= require jquery_ujs</span>
<span class="c1">//= require bootstrap</span>
<span class="c1">//= require turbolinks</span>
<span class="c1">//= require_tree .</span>
</pre></div>
</div></div>


<p>上のコードは、Sprocketsライブラリを使用してBootstrap JavaScriptをインクルードします。<a class="ref" href="./filling-in-the-layout.html#sec-custom_css">5.1.2</a>で<tt>bootstrap-sass</tt> gemを導入してあるので、これでBootstrapが利用できるようになります。</p>

<p><a class="ref" href="./sign-in-sign-out.html#code-layout_signin_signout_links">リスト8.24</a>のコードを使用することで、すべてのテストにパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>以上の変更を行ったことで、<a class="ref" href="./sign-in-sign-out.html#fig-profile_with_signout_link">図8.9</a>に示したように、<a class="ref" href="./sign-in-sign-out.html#code-layout_signin_signout_links">リスト8.24</a>で定義したドロップダウンメニューがサインインしたユーザーに表示されるようになりました。</p>

<div class="label" id="fig-profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/profile_with_signout_link_bootstrap.png" alt="profile_with_signout_link_bootstrap" /></span></div><div class="caption"><span class="header">図8.9</span><span class="description">サインインしたユーザーにリンクとドロップダウンが表示されるようになった。<a href="../images/figures/profile_with_signout_link_bootstrap-full.png">(拡大)</a></span></div></div>


<p>この時点で、ブラウザで実際にサインインできることを確認し、続いてブラウザを閉じてから再度サンプルアプリケーションを表示するとサインインしたままになっていることを確認してください。その気になれば、ブラウザのcookiesをブラウザで調べて結果を直接確認することもできます (<a class="ref" href="./sign-in-sign-out.html#fig-cookie_in_browser">図8.10</a>)。</p>

<div class="label" id="fig-cookie_in_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="../images/figures/cookie_in_browser.png" alt="cookie_in_browser" /></span></div><div class="caption"><span class="header">図8.10</span><span class="description">ローカルのブラウザで記憶トークンのcookiesを表示する。<a href="../images/figures/cookie_in_browser-full.png">(拡大)</a></span></div></div>




<div class="label" id="sec-signin_upon_signup"></div>


<h3><a id="sec-8_2_5" href="./sign-in-sign-out.html#sec-signin_upon_signup" class="heading"><span class="number">8.2.5</span>ユーザー登録と同時にサインインする</a></h3>


<p>認証機能の基本的な部分はできましたが、ユーザーが登録を行った後、そのユーザーがデフォルトではサインインしておらず、このままではユーザーが混乱する可能性があります。そこで、サインアウトの機能を実装する前にその部分をもう少し作り込みましょう。最初に、認証のテストを追加します (<a class="ref" href="./sign-in-sign-out.html#code-sign_up_sign_in">リスト8.26</a>)。ここには、<a class="ref" href="./sign-up.html#sec-signup_exercises">7.6</a>の演習にある<a class="ref" href="./sign-up.html#code-after_save_tests">リスト7.32</a>でも使った “after saving the user” <code>describe</code>ブロックが含まれています。このリストに対応する演習を行なっていなかった方は、この時点で追加する必要があります。</p>

<div class="label" id="code-sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.26</span> <span class="description">新規ユーザー登録後にユーザーがサインインしたことをテストする。</span><br /><span class="description"> <code>spec/requests/user_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;User pages&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="n">submit</span> <span class="p">}</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by</span><span class="p">(</span><span class="ss">email:</span> <span class="s1">&#39;user@example.com&#39;</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-success&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Welcome&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>上のコードでは、ユーザー登録後にサインインしていることを確認するために、サインアウト用のリンクが表示されているかどうかをテストしています。</p>

<p><a class="ref" href="./sign-in-sign-out.html#sec-signin_success">8.2</a>で<code>sign_in</code>メソッドを作成してあるので、ユーザーをデータベースに保存した直後に<code>sign_in @user</code>を追加するだけで、ユーザーが実際にサインインしてテストにパスするようになります (<a class="ref" href="./sign-in-sign-out.html#code-signin_upon_signup">リスト8.27</a>)。</p>

<div class="label" id="code-signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.27</span> <span class="description">ユーザー登録後にサインアップする。</span><br /><span class="description"> <code>app/controllers/users_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Welcome to the Sample App!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec-signing_out"></div>


<h3><a id="sec-8_2_6" href="./sign-in-sign-out.html#sec-signing_out" class="heading"><span class="number">8.2.6</span>サインアウトする</a></h3>


<p><a class="ref" href="./sign-in-sign-out.html#sec-signin_failure">8.1</a>で説明したとおり、このアプリケーションで使用する認証モデルでは、ユーザーは明示的にサインアウトするまでサインインしたままになります。この節では、そのサインアウト機能を追加します。</p>

<p>Sessionsコントローラのアクションは、これまでもRESTful慣例に従ってサインインページには<code>new</code>を使用し、サインインの完了には<code>create</code>を使用しました。今回も同様に慣例に従い、セッションの削除 (サインアウト) には<code>destroy</code>を使用します。このことをテストするには、[Sign out] リンクをクリックして、そこにサインイン用のリンクが再び現れるかどうかを確認します (<a class="ref" href="./sign-in-sign-out.html#code-signout_test">リスト8.28</a>)。</p>

<div class="label" id="code-signout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.28</span> <span class="description">ユーザーのサインアウトをテストする。</span><br /><span class="description"> <code>spec/requests/authentication_pages_spec.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">describe</span> <span class="s2">&quot;after saving the user&quot;</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="n">describe</span> <span class="s2">&quot;followed by signout&quot;</span> <span class="k">do</span>
          <span class="n">before</span> <span class="p">{</span> <span class="n">click_link</span> <span class="s2">&quot;Sign out&quot;</span> <span class="p">}</span>
          <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>サインインが<code>sign_in</code>関数に依存しているのと同様に、サインアウトでも<code>sign_out</code>関数を単に実行します (<a class="ref" href="./sign-in-sign-out.html#code-destroy_session">リスト8.29</a>)。</p>

<div class="label" id="code-destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.29</span> <span class="description">セッションを削除する (ユーザーのサインアウト)。</span><br /><span class="description"> <code>app/controllers/sessions_controller.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_url</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>他の認証用機能と同様に、<code>sign_out</code>もSessionsヘルパーモジュールの中に置きます。実装は極めてシンプルです。現在のユーザーを<code>nil</code>にし、<code>delete</code>メソッドを使用して、cookiesにあるセッションの記憶トークンを削除します (<a class="ref" href="./sign-in-sign-out.html#code-sign_out_method">リスト8.30</a>)。(<code>destroy</code>アクション内ですぐにリダイレクトされるので、現在のユーザーを<code>nil</code>にする必要は必ずしもありません。ただし、リダイレクトなしで<code>sign_out</code>を使用したい状況が今後発生するかもしれないので、そのときに役立つでしょう。)</p>

<div class="label" id="code-sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.30</span> <span class="description">Sessionsヘルパーモジュールの<code>sign_out</code>メソッド。</span><br /><span class="description"> <code>app/helpers/sessions_helper.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">remember_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_remember_token</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">remember_token</span>
    <span class="n">user</span><span class="o">.</span><span class="n">update_attribute</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">,</span> <span class="no">User</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">remember_token</span><span class="p">))</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>これでユーザー登録/サインイン/サインアウトがすべて揃いました。テストスイートはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>本書のテストスイートは認証システムをほぼカバーしていますが、すべてをカバーしているわけではありません。この点をご了承ください。たとえば、[このアカウント設定を保存する] の cookies (remember me) が有効になっているか、その後も保持されているかどうかのテストは含まれていません。このテストは作成可能ですが、著者の経験上、cookiesの値を直接調べる方法はRailsの実装に左右されやすい傾向があり、次のバージョンのRailsではまた変わるかもしれません。その場合、アプリケーションコードは正常に動作してもテストが正常に動作しなくなります。このような理由で、本書のテストコードでは、コアとなるアプリケーションコードをテストする際に高度な機能 (ユーザーがサインインできること、ページ移動後もサインインしていること、サインアウトできること) に重点を置き、重要性の低い機能は必ずしも含んでいません。</p>

<div class="label" id="sec-cucumber"></div>


<h2><a id="sec-8_3" href="./sign-in-sign-out.html#sec-cucumber" class="heading"><span class="number">8.3</span>Cucumberの紹介 (オプション)</a></h2>


<p>サンプルアプリケーションの認証システムの基礎部分が無事完成したので、この機会に<a href="http://cukes.info">Cucumber</a>を使用したサインインのテスト方法をご紹介します。Cucumberは振舞駆動開発用のツールとして有名で、Rubyコミュニティに多くの愛用者がいます。この節の内容は必須ではありませんので、スキップしても問題ありません。</p>

<p>Cucumberを使用すると、アプリケーションの振る舞いをテキストベースの「<em>ストーリー</em>」で定義することができます。多くのRailsプログラマーは、Cucumberは顧客と共同作業するときに便利であることを知っています。Cucumberのストーリーは、専門知識のない人でも読むことができ、ストーリーを顧客と共有したり、場合によっては顧客がストーリーを作成することすらできるためです。もちろん、テスティングのフレームワークが純粋なRubyでないという点は残念でもあり、著者にとってはテキストベースのストーリーはいささか冗長な面もあると思われます。それでもCucumberはRubyのテスティングツールキットとして確固たる地位を占めており、著者としては低レベルの実装を気にすることなく高度な振る舞いを記述できる点が特に気に入っています。</p>

<p>本書ではRSpecとCapybaraをテスティングのメインに据えているので、この節のCucumberに関する説明は完全ではなく、表面的で物足りないことでしょう。この節の目的はCucumberのおいしさ (間違いなくシャキシャキして汁気たっぷりです) を知ってもらうための、いわば試食です。もし気に入っていただけたら、テスティングツールに関する完結した書籍がいくつもあります。(おすすめは「<a href="http://amzn.to/T6rUvx"><em>The RSpec Book</em></a> 」(David Chelimsky著)、「 <a href="http://amzn.to/1sRCfHM"><em>Rails 3 in Action</em></a> 」(Ryan Bigg、Yehuda Katz著)、 「<a href="http://amzn.to/1g8AmV1"><em>The Cucumber Book</em></a>」(Matt Wynne、Aslak Hellesøy著) です)。(訳注: 日本語で読めるCucumberの書籍としては「<a href='http://tatsu-zine.com/books/cuke'>はじめる！Cucumber</a>」(諸橋 恭介著) があります。)</p>

<div class="label" id="sec-installation_and_setup"></div>


<h3><a id="sec-8_3_1" href="./sign-in-sign-out.html#sec-installation_and_setup" class="heading"><span class="number">8.3.1</span>インストールと設定</a></h3>


<p>Cucumberをインストールするには、最初に<tt>cucumber-rails</tt> gemと<tt>database_cleaner</tt>というユーティリティgemを<code>Gemfile</code>の<code>:test</code>グループに追加します (<a class="ref" href="./sign-in-sign-out.html#code-cucumber_rails">リスト8.31</a>)。</p>

<div class="label" id="code-cucumber_rails"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.31</span> <span class="description"><tt>cucumber-rails</tt> gemを<code>Gemfile</code>に追加する。</span> </div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.4.0&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="ss">github:</span> <span class="s1">&#39;bmabey/database_cleaner&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>次に、いつものように以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>アプリケーションでCucumberを使用するための設定を行うために、次は必要なサポート用ファイルとディレクトリを生成します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate cucumber:install
</pre></div>
</div>


<p>上のコマンドにより、Cucumber関連のファイルが置かれる<code>features/</code>ディレクトリが作成されます。</p>

<div class="label" id="sec-features_and_steps"></div>


<h3><a id="sec-8_3_2" href="./sign-in-sign-out.html#sec-features_and_steps" class="heading"><span class="number">8.3.2</span>フィーチャーとステップ</a></h3>


<p>Cucumberでは、<a href="https://github.com/cucumber/gherkin">Gherkin</a> (キュウリ属の植物: ガーキン) と呼ばれるテキストベースの言語を使用して、アプリケーションに期待される振る舞いを記述します。Gherkinで書かれたテストは、ちゃんと書かれたRSpecの例と同じぐらい読みやすくできています。どちらもテキストベースであり、自然な英語に近くRubyコードよりも読みやすいためです。</p>

<p>ここでは、<a class="ref" href="./sign-in-sign-out.html#code-initial_failing_signin_test">リスト8.5</a>と<a class="ref" href="./sign-in-sign-out.html#code-signin_success_tests">リスト8.6</a>のサインインのテスト例のサブセットをCucumberで実装してみましょう。最初に、<code>features/</code>ディレクトリ内に<code>signing_in.feature</code>というファイルを作成します。</p>

<p>Cucumberのフィーチャーファイルは、以下のようにその機能の簡単な説明から始まります。</p>

<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>
</pre></div>
</div>


<p>次に個別の<em>シナリオ</em>を追加します。たとえば、サインイン失敗をテストするには、以下のようなシナリオを作成します。</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>同様に、サインイン成功をテストするために以下を使用できます。</p>

<div class="code"><div class="highlight"><pre><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div>


<p>これらをまとめたものを<a class="ref" href="./sign-in-sign-out.html#code-signin_features">リスト8.32</a>に示します。</p>

<div class="label" id="code-signin_features"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.32</span> <span class="description">ユーザーのサインインをテストするCucumberのフィーチャーファイル。</span><br /><span class="description"> <code>features/signing_in.feature</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="k">Feature:</span><span class="nf"> Signing in</span>

<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Unsuccessful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see an error message</span>

<span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Successful signin</span>
<span class="k">    Given </span><span class="nf">a user visits the signin page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">the user has an account</span>
<span class="nf">    </span><span class="k">When </span><span class="nf">the user submits valid signin information</span>
<span class="nf">    </span><span class="k">Then </span><span class="nf">he should see his profile page</span>
<span class="nf">      </span><span class="k">And </span><span class="nf">he should see a signout link</span>
</pre></div>
</div></div>


<p>これらのフィーチャーを実行するには、<code>cucumber</code>実行ファイルを以下のように実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>上のCucumberのコマンドを、下のRSpecのコマンドと比較してみてください。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>ここからおわかりだと思いますが、CucumberはRSpecと同様Rakeタスクから呼び出すこともできます。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rake cucumber
</pre></div>
</div>


<p>(<code>rake cucumber:ok</code>と書くこともできます)。</p>

<p>まだテキストを書いただけなので、当然ながらこのままではCucumberのシナリオはテストにパスしません。テストスイートが緑色 (成功) になるためには、テキストファイルをRubyコードにマップする<em>ステップ</em>ファイルを作成します。ステップファイルは<code>features/step_definitions</code>ディレクトリに置きます。ファイル名はここでは<code>authentication_steps.rb</code>とします。</p>

<p><code>Feature</code>行と<code>Scenario</code>行は説明のためのものですが、それ以外の行はRubyに対応付けられる必要があります。たとえば、フィーチャーファイルにある以下のコードは、</p>

<div class="code"><div class="highlight"><pre><span class="k">Given </span><span class="nf">a user visits the signin page</span>
</pre></div>
</div>


<p>以下のステップ定義によって扱われます。</p>

<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>
</pre></div>
</div>


<p>フィーチャーファイルの中では<code>Given</code>は単なる文字列ですが、ステップファイルの中では<code>Given</code>は<em>メソッド</em>であり、正規表現とブロックを引数に取ります。この正規表現はシナリオの中の行とマッチし、次のブロックの内容は、そのステップを実装するために必要なRubyのコードです。この場合、“a user visits the signin page”という記述は以下のコードによって実装されます。</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>上のコードはどこかで見たことがあると思ったら、それもそのはず、Capybaraです。CapybaraはデフォルトでCucumberのステップファイルに含まれます。次の2行もわかりやすいと思います。</p>

<div class="code"><div class="highlight"><pre><span class="k">When </span><span class="nf">he submits invalid signin information</span>
<span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>上のフィーチャーファイルのコードは、ステップファイルでは以下のように扱われます。</p>

<div class="code"><div class="highlight"><pre><span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>最初のステップでもCapybaraが使用されていますが、その次のステップではCapybaraの<code>page</code>オブジェクトとRSpecが併用されています。見てのとおり、RSpecとCapybaraで行えるテストは、すべてCucumberでも行えます。</p>

<p>残りのステップも同様に進められます。最終的なステップ定義ファイルを<a class="ref" href="./sign-in-sign-out.html#code-authentication_steps">リスト8.33</a>に示します。ステップを追加したら、以下を実行します。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>


<p>テストにパスするまでこれを繰り返します。</p>

<div class="label" id="code-authentication_steps"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.33</span> <span class="description">サインインフィーチャーがパスするための完全なステップ定義。</span><br /><span class="description"> <code>features/step_definitions/authentication_steps.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="no">Given</span> <span class="sr">/^a user visits the signin page$/</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">signin_path</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^he submits invalid signin information$/</span> <span class="k">do</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Given</span> <span class="sr">/^the user has an account$/</span> <span class="k">do</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">email:</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                      <span class="ss">password:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">password_confirmation:</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^the user submits valid signin information$/</span> <span class="k">do</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see his profile page$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_title</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Then</span> <span class="sr">/^he should see a signout link$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-in-sign-out.html#code-authentication_steps">リスト8.33</a>のコードにより、以下のCucumberのテストはパスするはずです。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>cucumber features/
</pre></div>
</div>




<div class="label" id="sec-rspec_custom_matchers"></div>


<h3><a id="sec-8_3_3" href="./sign-in-sign-out.html#sec-rspec_custom_matchers" class="heading"><span class="number">8.3.3</span>対比: RSpecのカスタムマッチャー</a></h3>


<p>簡単なCucumberのシナリオをいくつか紹介したので、それらと同等のRSpecの例と比較してみましょう。まず、<a class="ref" href="./sign-in-sign-out.html#code-signin_features">リスト8.32</a>のCucumberフィーチャーと、それに対応する<a class="ref" href="./sign-in-sign-out.html#code-authentication_steps">リスト8.33</a>のステップ定義をもう一度見てみましょう。次に、以下のRSpecリクエストspec (結合テスト) を見てみましょう。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Authentication&quot;</span> <span class="k">do</span>

  <span class="n">subject</span> <span class="p">{</span> <span class="n">page</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">&quot;signin&quot;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">visit</span> <span class="n">signin_path</span> <span class="p">}</span>

    <span class="n">describe</span> <span class="s2">&quot;with invalid information&quot;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span> <span class="p">}</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">upcase</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_title</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">,</span>     <span class="ss">href:</span> <span class="n">user_path</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign out&#39;</span><span class="p">,</span>    <span class="ss">href:</span> <span class="n">signout_path</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">have_link</span><span class="p">(</span><span class="s1">&#39;Sign in&#39;</span><span class="p">,</span> <span class="ss">href:</span> <span class="n">signin_path</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Cucumberと結合テストでそれぞれどのように実装されているかがおわかりいただけると思います。Cucumberのフィーチャーは非常に読みやすいのですが、その代わり実装されているコードから完全に切り離されていて、両刃の剣です。著者にとって、Cucumberは読みやすいが書くのは面倒、結合テストはプログラマーにとってはそれほど読みやすくない代わりに書くのは<em>はるかに</em>楽、という印象です。</p>

<p>Cucumberではフィーチャーとステップが分離されていることにより、抽象度の高い記述が可能であるという効果があります。以下のフィーチャーは、エラーメッセージが表示されるはずであるということを記述しています。</p>

<div class="code"><div class="highlight"><pre><span class="k">Then </span><span class="nf">he should see an error message</span>
</pre></div>
</div>


<p>そして以下のステップファイルでは、このテストを実装しています。</p>

<div class="code"><div class="highlight"><pre><span class="no">Then</span> <span class="sr">/^he should see an error message$/</span> <span class="k">do</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>これが特に便利なのは、実装に依存するのが2番目の要素であるステップファイルだけである点です。そのため、たとえばエラーメッセージを表示するためのCSSを変更しても、フィーチャーファイルは変更不要です。</p>

<p>同様に、以下のようなコードを何度も書くのは多くの人にとって苦痛だと思います。</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>本当に行いたいのは、そのページでエラーメッセージが表示されることを示すことのはずです。しかも、上の記法は実装に密着しているので、実装が変更されたらそれらもすべて変更が必要になります。純粋なRSpecでは、<em>カスタムマッチャー</em>を使用してこの問題を解決することができます。カスタムマッチャーを使用すると、上のコードを以下のように簡潔に記述することができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span>
</pre></div>
</div>


<p>このマッチャーは、<a class="ref" href="./filling-in-the-layout.html#sec-pretty_rspec">5.3.4</a>で<code>full_title</code>テストヘルパーを置いたのと同じユーティリティファイル内で定義することができます。コード自体は以下のようになります。</p>

<div class="code"><div class="highlight"><pre><span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>同様に、よく使われる操作をヘルパーメソッドとして定義することもできます。</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>
</pre></div>
</div>


<p>作成したサポートコードを<a class="ref" href="./sign-in-sign-out.html#code-have_error_message">リスト8.34</a>に示します (<a class="ref" href="./filling-in-the-layout.html#sec-layout_exercises">5.6</a>の演習の<a class="ref" href="./filling-in-the-layout.html#code-full_title_helper_tests">リスト5.38</a>と<a class="ref" href="./filling-in-the-layout.html#code-rspec_utilities_simplified">リスト5.39</a>の結果を含みます)。 この方法は、Cucumberのステップ定義よりも柔軟であることがわかってきました。特に、マッチャーやshouldヘルパーが<code>valid_signin(user)</code>のように引数を自然に取ることができます。ステップ定義は正規表現マッチャーによって繰り返すことができますが、この手法は一般に厄介なものになりやすいという印象です。</p>

<div class="label" id="code-have_error_message"></div>


<div class="codelisting">
<div class="listing"><span class="header">リスト8.34</span> <span class="description">ヘルパーメソッドとカスタムRSpecマッチャーを追加する。</span><br /><span class="description"> <code>spec/support/utilities.rb</code></span> </div>
<div class="code"><div class="highlight"><pre><span class="kp">include</span> <span class="no">ApplicationHelper</span>

<span class="k">def</span> <span class="nf">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>    <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
  <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="ss">with:</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
  <span class="n">click_button</span> <span class="s2">&quot;Sign in&quot;</span>
<span class="k">end</span>

<span class="ss">RSpec::Matchers</span><span class="o">.</span><span class="n">define</span> <span class="ss">:have_error_message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">match</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;div.alert.alert-error&#39;</span><span class="p">,</span> <span class="ss">text:</span> <span class="n">message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p><a class="ref" href="./sign-in-sign-out.html#code-have_error_message">リスト8.34</a>を使用することで、以下のように書くことができます。</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">have_error_message</span><span class="p">(</span><span class="s1">&#39;Invalid&#39;</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
</div>


<p>以下も同様です。</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;with valid information&quot;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before</span> <span class="p">{</span> <span class="n">valid_signin</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>テストとサイトの実装を結びつける方法の例は他にも多数あります。現在のテストスイート全般にわたって、カスタムマッチャーとカスタムメソッドを作成してテストと実装の詳細を切り離す作業については、演習に回すことにします (<a class="ref" href="./sign-in-sign-out.html#sec-sign_in_out_exercises">8.5</a>)。</p>

<h2><a id="sec-8_4" href="./sign-in-sign-out.html#sec-8_4" class="heading"><span class="number">8.4</span>最後に</a></h2>


<p>本章では多くの分野をカバーし、約束どおり、かつて未成熟だったアプリケーションを、ユーザー登録とログインをフル装備したWebサイトに変身させました。認証機能を完成させるためには、サインインの状態とユーザーidに基いてページのアクセスに制限を与える必要もあります。ページごとのアクセス制限機能の実装については、ユーザー情報を編集する機能と、ユーザーをシステムから削除できる権限を管理者に与える機能を実装するときに同時に行う予定です。このアクセス制限は、<a class="ref" href="./updating-showing-and-deleting-users.html#top">第9章</a>の主な目標でもあります。</p>

<p>次の章に進む前に、変更をmasterブランチにマージしておきましょう。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finish sign in&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<p>次にリモートのGitHubリポジトリとHerokuの本番サーバーにプッシュします。</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku run rake db:migrate
</pre></div>
</div>


<div class="label" id="sec-sign_in_out_exercises"></div>


<h2><a id="sec-8_5" href="./sign-in-sign-out.html#sec-sign_in_out_exercises" class="heading"><span class="number">8.5</span>演習</a></h2>




<ol>

<li><code>form_for</code>の代わりに<code>form_tag</code>を使用して、サインインフォームをリファクタリングしてください。テストスイートが以前と同様にパスすることも確認してください。<em>ヒント</em>: RailsCastの「<a href="http://railscasts.com/episodes/270-authentication-in-rails-3-1">Rails 3.1における認証</a> (英語)」を参照してください。特に、<code>params</code>ハッシュの構造の変更に注目してください。</li>

<li><a class="ref" href="./sign-in-sign-out.html#sec-rspec_custom_matchers">8.3.3</a>の例に従い、ユーザー用リクエストspecと認証リクエストspec (<code>spec/requests</code>ディレクトリの下にあるファイル) を見直し、<code>spec/support/utilities.rb</code>でユーティリティ関数を定義して、テストを実装から切り離してください。<em>課外活動:</em> サポートコードを独立したファイルとモジュールに再編成し、specヘルパーファイルでそれらのモジュールを適切にインクルードしてすべて動作するようにしてください。</li>

</ol>




<div class="navigation">  <a class="prev_page" href="./sign-up.html#top">
</a><a class="prev_page" href="./sign-up.html#top">    « <span class="number">第7章</span>ユーザー登録</a><a class="prev_page" href="./sign-up.html#top">  </a>
  <a class="next_page" href="./updating-showing-and-deleting-users.html#top">
</a><a class="next_page" href="./updating-showing-and-deleting-users.html#top">    <span class="number">第9章</span> ユーザーの更新表示削除 »
</a><a class="next_page" href="./updating-showing-and-deleting-users.html#top">  </a>
</div><div class="footnotes">
<ol>
<li id="fn-8_1">他に、一定時間が経過するとセッションを期限切れにするモデルもあります。このモデルは、インターネットバンキングや金融取引口座などの重要な情報を扱うWebサイトに向いています。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_1">↑</a></li>
<li id="fn-8_2">画像は<a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>からの引用です。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_2">↑</a></li>
<li id="fn-8_3">このメソッドは、RailsCastの「<a href="http://railscasts.com/episodes/274-remember-me-reset-password">remember me</a>」の記事を元に選びました。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_3">↑</a></li>
<li id="fn-8_4">Active Recordでサポートされるコールバックの種類の詳細については、Rails Guidesの「<a href="http://guides.rubyonrails.org/v3.2.13/active_record_validations_callbacks.html">コールバックについて</a> (英語)」を参照してください。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_4">↑</a></li>
<li id="fn-8_5">実は、この2つは完全に同等です。<code>attr_accessor</code>は、単にゲッターメソッドやセッターメソッドを自動的に作成する便利な方法でしかありません。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_5">↑</a></li>
<li id="fn-8_6">通常、これは初期値が<code>nil</code>である変数への代入を意味しますが、<code>false</code>値も<code>||=</code>演算子によって上書きされることに注意してください。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_6">↑</a></li>
<li id="fn-8_7">これは、<a class="ref" href="./modeling-users.html#sidebar-let">コラム 6.3</a>で説明した<em>メモ化 (memoization) </em>の例になっています。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_7">↑</a></li>
<li id="fn-8_8">Webブラウザは実際には<tt>DELETE</tt>リクエストを発行できないので、RailsではJavaScriptを使用してこのリクエストを偽造します。<a class="arrow" href="./sign-in-sign-out.html#fnref-8_8">↑</a></li>
</ol>
</div>




    </div>
  </body>
</html>
